<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Reproducible Finance with R</title>
  <meta name="description" content="A reproducible for Chapman &amp; Hall.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Reproducible Finance with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A reproducible for Chapman &amp; Hall." />
  <meta name="github-repo" content="jkr216/reproducible-finance-ch" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Reproducible Finance with R" />
  
  <meta name="twitter:description" content="A reproducible for Chapman &amp; Hall." />
  

<meta name="author" content="Jonathan K. Regenstein, Jr.">


<meta name="date" content="2018-01-17">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="portfolio-theory.html">
<link rel="next" href="sortino-ratio.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.9/htmlwidgets.js"></script>
<script src="libs/proj4js-2.3.15/proj4.js"></script>
<link href="libs/highcharts-5.0.6/css/motion.css" rel="stylesheet" />
<script src="libs/highcharts-5.0.6/highstock.js"></script>
<script src="libs/highcharts-5.0.6/highcharts-3d.js"></script>
<script src="libs/highcharts-5.0.6/highcharts-more.js"></script>
<script src="libs/highcharts-5.0.6/modules/annotations.js"></script>
<script src="libs/highcharts-5.0.6/modules/broken-axis.js"></script>
<script src="libs/highcharts-5.0.6/modules/data.js"></script>
<script src="libs/highcharts-5.0.6/modules/drilldown.js"></script>
<script src="libs/highcharts-5.0.6/modules/exporting.js"></script>
<script src="libs/highcharts-5.0.6/modules/funnel.js"></script>
<script src="libs/highcharts-5.0.6/modules/heatmap.js"></script>
<script src="libs/highcharts-5.0.6/modules/map.js"></script>
<script src="libs/highcharts-5.0.6/modules/no-data-to-display.js"></script>
<script src="libs/highcharts-5.0.6/modules/offline-exporting.js"></script>
<script src="libs/highcharts-5.0.6/modules/solid-gauge.js"></script>
<script src="libs/highcharts-5.0.6/modules/treemap.js"></script>
<script src="libs/highcharts-5.0.6/plugins/annotations.js"></script>
<script src="libs/highcharts-5.0.6/plugins/draggable-legend.js"></script>
<script src="libs/highcharts-5.0.6/plugins/draggable-points.js"></script>
<script src="libs/highcharts-5.0.6/plugins/export-csv.js"></script>
<script src="libs/highcharts-5.0.6/plugins/grouped-categories.js"></script>
<script src="libs/highcharts-5.0.6/plugins/motion.js"></script>
<script src="libs/highcharts-5.0.6/plugins/pattern-fill-v2.js"></script>
<script src="libs/highcharts-5.0.6/plugins/tooltip-delay.js"></script>
<script src="libs/highcharts-5.0.6/custom/reset.js"></script>
<script src="libs/highcharts-5.0.6/custom/symbols-extra.js"></script>
<script src="libs/highcharts-5.0.6/custom/text-symbols.js"></script>
<link href="libs/fontawesome-4.5.0/font-awesome.min.css" rel="stylesheet" />
<link href="libs/htmlwdgtgrid-1/htmlwdgtgrid.css" rel="stylesheet" />
<script src="libs/highchart-binding-0.5.0/highchart.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> install the packages needed by this book; you fill out c(), e.g. c(‘ggplot2’, ‘dplyr’)</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-read-this-book"><i class="fa fa-check"></i>Why read this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#structure-of-the-book"><i class="fa fa-check"></i>Structure of the book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-author"><i class="fa fa-check"></i>About the Author</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#software-information-and-conventions"><i class="fa fa-check"></i>Software information and conventions</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgments"><i class="fa fa-check"></i>Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html"><i class="fa fa-check"></i>Returns</a><ul>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#importing-asset-prices"><i class="fa fa-check"></i>Importing Asset Prices</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#thoughts-on-converting-daily-prices-to-monthly-log-returns"><i class="fa fa-check"></i>Thoughts on Converting Daily Prices to Monthly Log Returns</a></li>
<li><a href="returns.html#converting-daily-prices-to-monthly-returns-in-the-xts-world">Converting Daily Prices to Monthly Returns in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#converting-daily-prices-to-monthly-returns-in-the-tidyverse"><i class="fa fa-check"></i>Converting Daily Prices to Monthly Returns in the Tidyverse</a></li>
<li><a href="returns.html#converting-daily-prices-to-monthly-returns-in-the-tidyquant-world">Converting Daily Prices to Monthly Returns in the <code>tidyquant</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#a-word-on-workflow-and-recap"><i class="fa fa-check"></i>A Word on workflow and recap</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#visualizing-asset-returns-before-they-get-mashed-into-a-portfolio"><i class="fa fa-check"></i>Visualizing Asset Returns before they get mashed into a portfolio</a></li>
<li><a href="returns.html#portfolio-returns-in-the-xts-world">Portfolio Returns in the <code>xts</code> world</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#portfolio-returns-in-the-tidyverse"><i class="fa fa-check"></i>Portfolio Returns in the tidyverse</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#portfolio-returns-in-the-tidyquant-world"><i class="fa fa-check"></i>Portfolio Returns in the tidyquant World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#visualizing-portfolio-returns"><i class="fa fa-check"></i>Visualizing Portfolio Returns</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#our-first-shiny-app-portfolio-returns"><i class="fa fa-check"></i>Our First Shiny App: Portfolio Returns</a></li>
<li><a href="returns.html#portfolio-growth-in-the-xts-world">Portfolio Growth in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#portfolio-growth-in-the-tidyverse"><i class="fa fa-check"></i>Portfolio Growth in the Tidyverse</a></li>
<li><a href="returns.html#portfolio-growth-in-the-tidyquant-world">Portfolio Growth in the <code>tidyquant</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#visualizing-portfolio-growth"><i class="fa fa-check"></i>Visualizing Portfolio Growth</a></li>
<li class="chapter" data-level="1.0.1" data-path="returns.html"><a href="returns.html#shiny-growth-of-a-dollar"><i class="fa fa-check"></i><b>1.0.1</b> Shiny Growth of a Dollar</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#concluding"><i class="fa fa-check"></i>Concluding</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html"><i class="fa fa-check"></i>Risk</a><ul>
<li><a href="risk.html#standard-deviation-in-the-xts-world">Standard Deviation in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#standard-devation-in-the-tidyverse"><i class="fa fa-check"></i>Standard Devation in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#standard-deviation-in-the-tidyquant-world"><i class="fa fa-check"></i>Standard Deviation in the Tidyquant World</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-standard-deviation"><i class="fa fa-check"></i>Visualizing Standard Deviation</a></li>
<li class="chapter" data-level="1.0.2" data-path="risk.html"><a href="risk.html#rolling-standard-deviation-in-the-xts-world"><i class="fa fa-check"></i><b>1.0.2</b> Rolling Standard Deviation in the <code>xts</code> world</a></li>
<li class="chapter" data-level="1.0.3" data-path="risk.html"><a href="risk.html#rolling-standard-deviation-in-tidyverse"><i class="fa fa-check"></i><b>1.0.3</b> Rolling Standard Deviation in tidyverse</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#rolling-standard-deviation-with-tidyquant"><i class="fa fa-check"></i>Rolling Standard Deviation with tidyquant</a></li>
<li><a href="risk.html#visualizing-rolling-standard-deviation-in-the-xts-world">Visualizing Rolling Standard Deviation in the <code>xts</code> world</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-rolling-standard-deviation-in-the-tidyverse"><i class="fa fa-check"></i>Visualizing Rolling Standard Deviation in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#shiny-app"><i class="fa fa-check"></i>Shiny App</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-component-contribution"><i class="fa fa-check"></i>Visualizing Component Contribution</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-component-contribution-to-volatility"><i class="fa fa-check"></i>Visualizing Component Contribution to Volatility</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#shiny-component-contribution"><i class="fa fa-check"></i>Shiny Component Contribution</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#conclusion-on-standard-deviation"><i class="fa fa-check"></i>Conclusion on Standard Deviation</a></li>
<li class="chapter" data-level="1.0.4" data-path="risk.html"><a href="risk.html#skewness-in-the-xts-world"><i class="fa fa-check"></i><b>1.0.4</b> Skewness in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#skewness-in-the-tidyverse"><i class="fa fa-check"></i>Skewness in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-skewness"><i class="fa fa-check"></i>Visualizing Skewness</a></li>
<li><a href="risk.html#rolling-skewness-in-the-xts-world">Rolling Skewness in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#rolling-skewness-in-the-tidyverse"><i class="fa fa-check"></i>Rolling Skewness in the tidyverse</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#rolling-skewness-in-the-tidyquant-world"><i class="fa fa-check"></i>Rolling Skewness in the Tidyquant World</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-rolling-skewness"><i class="fa fa-check"></i>Visualizing Rolling Skewness</a></li>
<li><a href="risk.html#kurtosis-in-the-xts-world">Kurtosis in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#kurtosis-in-the-tidyverse"><i class="fa fa-check"></i>Kurtosis in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-kurtosis"><i class="fa fa-check"></i>Visualizing Kurtosis</a></li>
<li><a href="risk.html#rolling-kurtosis-in-the-xts-world">Rolling Kurtosis in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#rolling-kurtosis-in-the-tidyquant-world"><i class="fa fa-check"></i>Rolling Kurtosis in the Tidyquant world</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#visualizing-rolling-kurtosis"><i class="fa fa-check"></i>Visualizing Rolling Kurtosis</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#shiny-skew-and-kurtosis"><i class="fa fa-check"></i>Shiny Skew and Kurtosis</a></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html#conclusion"><i class="fa fa-check"></i>Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="portfolio-theory.html"><a href="portfolio-theory.html"><i class="fa fa-check"></i>Portfolio Theory</a></li>
<li class="chapter" data-level="2" data-path="sharpe-ratio.html"><a href="sharpe-ratio.html"><i class="fa fa-check"></i><b>2</b> Sharpe Ratio</a><ul>
<li><a href="sharpe-ratio.html#sharpe-ratio-in-the-xts-world">Sharpe Ratio in the <code>xts</code> world</a></li>
<li class="chapter" data-level="" data-path="sharpe-ratio.html"><a href="sharpe-ratio.html#sharpe-ration-in-the-tidyverse"><i class="fa fa-check"></i>Sharpe Ration in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="sharpe-ratio.html"><a href="sharpe-ratio.html#shape-ratio-with-tidyquant"><i class="fa fa-check"></i>Shape Ratio with Tidyquant</a></li>
<li class="chapter" data-level="" data-path="sharpe-ratio.html"><a href="sharpe-ratio.html#visualizing-sharpe-ratios"><i class="fa fa-check"></i>Visualizing Sharpe Ratios</a></li>
<li><a href="sharpe-ratio.html#rolling-sharpe-ratio-in-the-xts-world">Rolling Sharpe Ratio in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="sharpe-ratio.html"><a href="sharpe-ratio.html#rolling-sharpe-ratio-with-tidyverse-tibbletime"><i class="fa fa-check"></i>Rolling Sharpe Ratio with Tidyverse + Tibbletime</a></li>
<li class="chapter" data-level="" data-path="sharpe-ratio.html"><a href="sharpe-ratio.html#visualizing-the-rolling-sharpe-ratio"><i class="fa fa-check"></i>Visualizing the Rolling Sharpe Ratio</a></li>
<li class="chapter" data-level="" data-path="sharpe-ratio.html"><a href="sharpe-ratio.html#shiny-for-sharpe-ratio"><i class="fa fa-check"></i>Shiny for Sharpe Ratio</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sortino-ratio.html"><a href="sortino-ratio.html"><i class="fa fa-check"></i><b>3</b> Sortino Ratio</a><ul>
<li><a href="sortino-ratio.html#calculating-sortino-ratio-in-the-xts-world">Calculating Sortino Ratio in the <code>xts</code> world</a></li>
<li class="chapter" data-level="" data-path="sortino-ratio.html"><a href="sortino-ratio.html#calculating-sortino-ratio-in-the-tidyverse"><i class="fa fa-check"></i>Calculating Sortino Ratio in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="sortino-ratio.html"><a href="sortino-ratio.html#calculating-sortino-ratio-in-the-tidyquant-world"><i class="fa fa-check"></i>Calculating Sortino Ratio in the Tidyquant world</a></li>
<li class="chapter" data-level="" data-path="sortino-ratio.html"><a href="sortino-ratio.html#visualizing-the-sortino-ratio"><i class="fa fa-check"></i>Visualizing the Sortino Ratio</a></li>
<li class="chapter" data-level="3.0.1" data-path="sortino-ratio.html"><a href="sortino-ratio.html#rolling-sortino-ratio-with-in-the-xts-world"><i class="fa fa-check"></i><b>3.0.1</b> Rolling Sortino Ratio with in the <code>xts</code> World</a></li>
<li class="chapter" data-level="3.0.2" data-path="sortino-ratio.html"><a href="sortino-ratio.html#rolling-sortino-ratio-with-in-tidyverse-tibbletime"><i class="fa fa-check"></i><b>3.0.2</b> Rolling Sortino Ratio with in tidyverse + tibbletime</a></li>
<li class="chapter" data-level="" data-path="sortino-ratio.html"><a href="sortino-ratio.html#visualizing-the-sortino-ratio-1"><i class="fa fa-check"></i>Visualizing the Sortino Ratio</a></li>
<li class="chapter" data-level="" data-path="sortino-ratio.html"><a href="sortino-ratio.html#shiny-sortino-ratio"><i class="fa fa-check"></i>Shiny Sortino Ratio</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="montecarlo.html"><a href="montecarlo.html"><i class="fa fa-check"></i><b>4</b> montecarlo</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="more-to-say.html"><a href="more-to-say.html"><i class="fa fa-check"></i><b>A</b> More to Say</a></li>
<li class="chapter" data-level="" data-path="appendix-2.html"><a href="appendix-2.html"><i class="fa fa-check"></i>Appendix 2</a></li>
<li class="chapter" data-level="B" data-path="generate-a-bibtex-database-automatically-for-some-r-packages.html"><a href="generate-a-bibtex-database-automatically-for-some-r-packages.html"><i class="fa fa-check"></i><b>B</b> generate a BibTeX database automatically for some R packages</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reproducible Finance with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sharpe-ratio" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Sharpe Ratio</h1>
<pre><code>## ── Attaching packages ───────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 2.2.1     ✔ purrr   0.2.4
## ✔ tibble  1.4.1     ✔ dplyr   0.7.4
## ✔ tidyr   0.7.2     ✔ stringr 1.2.0
## ✔ readr   1.1.1     ✔ forcats 0.2.0</code></pre>
<pre><code>## Warning: package &#39;ggplot2&#39; was built under R version 3.4.3</code></pre>
<pre><code>## Warning: package &#39;readr&#39; was built under R version 3.4.3</code></pre>
<pre><code>## Warning: package &#39;stringr&#39; was built under R version 3.4.3</code></pre>
<pre><code>## Warning: package &#39;forcats&#39; was built under R version 3.4.3</code></pre>
<pre><code>## ── Conflicts ──────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre><code>## Loading required package: lubridate</code></pre>
<pre><code>## 
## Attaching package: &#39;lubridate&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:base&#39;:
## 
##     date</code></pre>
<pre><code>## Loading required package: PerformanceAnalytics</code></pre>
<pre><code>## Loading required package: xts</code></pre>
<pre><code>## Loading required package: zoo</code></pre>
<pre><code>## 
## Attaching package: &#39;zoo&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     as.Date, as.Date.numeric</code></pre>
<pre><code>## 
## Attaching package: &#39;xts&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:dplyr&#39;:
## 
##     first, last</code></pre>
<pre><code>## 
## Attaching package: &#39;PerformanceAnalytics&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:graphics&#39;:
## 
##     legend</code></pre>
<pre><code>## Loading required package: quantmod</code></pre>
<pre><code>## Loading required package: TTR</code></pre>
<pre><code>## Version 0.4-0 included new data defaults. See ?getSymbols.</code></pre>
<pre><code>## 
## Attaching package: &#39;tidyquant&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     as_tibble</code></pre>
<pre><code>## The following object is masked from &#39;package:tibble&#39;:
## 
##     as_tibble</code></pre>
<pre><code>## 
## Attaching package: &#39;tibbletime&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     filter</code></pre>
<pre><code>## Highcharts (www.highcharts.com) is a Highsoft software product which is</code></pre>
<pre><code>## not free for commercial and Governmental use</code></pre>
<pre><code>## 
## Attaching package: &#39;scales&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     discard</code></pre>
<pre><code>## The following object is masked from &#39;package:readr&#39;:
## 
##     col_factor</code></pre>
<p>We start out journey into portfolio theory with an investigation of the Sharpe Ratio.</p>
<p>Briefly, the Sharpe Ratio is the mean of the excess portfolio returns above the risk-free rate, divided by the standard deviation of the excess monthly returns above the risk-free rate. This is the formulation of the Sharpe Ratio as of 1994; if we wished to use the original formulation from 1966 the denominator would be the standard deviation of portfolio monthly returns. Learn more here: web.stanford.edu/~wfsharpe/art/sr/sr.htm.</p>
<p>In other words, the Sharpe Ratio measures excess returns per unit of volatility, where we take the standard deviation to represent portfolio volatility. The Sharpe Ratio was brought to us by Bill Sharpe - arguably the most important economist for modern investment management as the creator of the Sharpe Ratio, CAPM (which we will cover later) and Financial Engines, a forerunner of today’s robo-advisor movement.</p>
<p>The Latex code for the Sharpe Ratio equation is as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="op">$</span><span class="er">$</span>Sharpe<span class="op">~</span>Ratio={(\overline{R_{p}<span class="op">-</span>R_{f}})}<span class="op">/</span>\sigma_{excess}<span class="op">$</span><span class="er">$</span></code></pre></div>
<p>And here is the output</p>
<p><span class="math display">\[Sharpe~Ratio={(\overline{R_{p}-R_{f}})}/\sigma_{excess}\]</span></p>
<p>The numerator is the mean excess return above the risk free rate and the numerator is the standard deviation of those excess returns. In other words, it’s a ratio of return to risk and so a higher Sharpe Ratio indicates a ‘better’ portfolio.</p>
<p>When working with the Sharpe Ratio, we have two critical choices: how to construct the portfolio using assets and weights, and which risk free to use. We’ve already chosen a portfolio and analyzed it’s risk and return, so that leaves a risk free rate. Let’s go with .03%. If you don’t like that one, please substitute and experiment at will!</p>
<p>Let’s assign the risk free rate to a variable called <code>rfr</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rfr &lt;-<span class="st"> </span>.<span class="dv">0003</span></code></pre></div>
<div id="sharpe-ratio-in-the-xts-world" class="section level3 unnumbered">
<h3>Sharpe Ratio in the <code>xts</code> world</h3>
<p>Calculating the Sharpe Ratio in the <code>xts</code> world is almost depressingly convenient. We call <code>SharpeRatio(portfolio_returns_xts, Rf = rfr)</code>, passing our portfolio returns and risk-free rate to the built-in function from <code>PerformanceAnalytics</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_xts &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">SharpeRatio</span>(portfolio_returns_xts_rebalanced_monthly, <span class="dt">Rf =</span> rfr) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  `</span><span class="dt">colnames&lt;-</span><span class="st">`</span>(<span class="st">&quot;ratio&quot;</span>)</code></pre></div>
<p>From a substantive perspective, we could stop here and start visualizing with <code>highcharter</code>. But we’re not going do that! Let’s head to the tidyverse.</p>
</div>
<div id="sharpe-ration-in-the-tidyverse" class="section level3 unnumbered">
<h3>Sharpe Ration in the Tidyverse</h3>
<p>For our tidyverse example, let’s use a by-hand calculation and implement it via pipes and <code>dplyr</code>.</p>
<p>We call start with our object <code>portfolio_returns_dplyr_byhand</code> and then invoke <code>summarise(ratio = mean(returns - rfr)/sd(returns - rfr))</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_tidyverse_byhand &lt;-<span class="st"> </span>
<span class="st">  </span>portfolio_returns_dplyr_byhand <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">ratio =</span> <span class="kw">mean</span>(returns <span class="op">-</span><span class="st"> </span>rfr)<span class="op">/</span><span class="kw">sd</span>(returns <span class="op">-</span><span class="st"> </span>rfr))

sharpe_tidyverse_byhand<span class="op">$</span>ratio</code></pre></div>
<pre><code>## [1] 0.2599818</code></pre>
</div>
<div id="shape-ratio-with-tidyquant" class="section level3 unnumbered">
<h3>Shape Ratio with Tidyquant</h3>
<p>Now on to <code>tidyquant</code>, which allows us to apply the <code>SharpeRatio()</code> function from <code>PerformanceAnalytics</code> to a <code>tibble</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_tq &lt;-<span class="st"> </span>
<span class="st">  </span>portfolio_returns_tq_rebalanced_monthly <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tq_performance</span>(<span class="dt">Ra =</span> returns,
                 <span class="dt">performance_fun =</span> SharpeRatio,
                 <span class="dt">Rf =</span> rfr) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  `</span><span class="dt">colnames&lt;-</span><span class="st">`</span>(<span class="st">&quot;ratio&quot;</span>)</code></pre></div>
<p>Let’s compare our 3 Sharpe objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_xts[<span class="dv">1</span>]</code></pre></div>
<pre><code>## [1] 0.2599818</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_tidyverse_byhand<span class="op">$</span>ratio</code></pre></div>
<pre><code>## [1] 0.2599818</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_tq<span class="op">$</span>ratio</code></pre></div>
<pre><code>## [1] 0.2599818</code></pre>
<p>We have consistent results from <code>xts</code>, <code>tidyquant</code> and our by-hand piped calculation. One issue with the Sharpe Ratio is that it’s most useful in comparison to other Sharpe Ratios. Is our portfolio’s Sharpe good, great, awful? Let’s compare it to the Sharpe Ratio of the S&amp;P500 in the same time period.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">market_returns_xts &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">getSymbols</span>(<span class="st">&quot;SPY&quot;</span>, 
               <span class="dt">src =</span> <span class="st">&#39;yahoo&#39;</span>, 
               <span class="dt">from =</span> <span class="st">&quot;2013-01-01&quot;</span>, 
               <span class="dt">to =</span> <span class="st">&quot;2017-12-31&quot;</span>, 
               <span class="dt">auto.assign =</span> <span class="ot">TRUE</span>, 
               <span class="dt">warnings =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">Ad</span>(<span class="kw">get</span>(.))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">reduce</span>(merge) <span class="op">%&gt;%</span>
<span class="st">    `</span><span class="dt">colnames&lt;-</span><span class="st">`</span>(<span class="st">&quot;SPY&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">to.monthly</span>(<span class="dt">indexAt =</span> <span class="st">&quot;last&quot;</span>, <span class="dt">OHLC =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## &#39;getSymbols&#39; currently uses auto.assign=TRUE by default, but will
## use auto.assign=FALSE in 0.5-0. You will still be able to use
## &#39;loadSymbols&#39; to automatically load data. getOption(&quot;getSymbols.env&quot;)
## and getOption(&quot;getSymbols.auto.assign&quot;) will still be checked for
## alternate defaults.
## 
## This message is shown once per session and may be disabled by setting 
## options(&quot;getSymbols.warning4.0&quot;=FALSE). See ?getSymbols for details.</code></pre>
<pre><code>## 
## WARNING: There have been significant changes to Yahoo Finance data.
## Please see the Warning section of &#39;?getSymbols.yahoo&#39; for details.
## 
## This message is shown once per session and may be disabled by setting
## options(&quot;getSymbols.yahoo.warning&quot;=FALSE).</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">market_sharpe &lt;-<span class="st"> </span>
<span class="st">  </span>market_returns_xts <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tk_tbl</span>(<span class="dt">preserve_index =</span> <span class="ot">TRUE</span>, <span class="dt">rename_index =</span> <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">returns =</span> (<span class="kw">log</span>(SPY) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="kw">lag</span>(SPY)))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">ratio =</span> <span class="kw">mean</span>(returns <span class="op">-</span><span class="st"> </span>rfr)<span class="op">/</span><span class="kw">sd</span>(returns <span class="op">-</span><span class="st"> </span>rfr))

market_sharpe<span class="op">$</span>ratio</code></pre></div>
<pre><code>## [1] 0.414671</code></pre>
<p>Uh oh, our portfolio has underperfomed the market - all of work for nothing! What might explain this? It’s been 5 years of inexorably bullish market behavior and that makes it hard to outperform.</p>
<p>In any event, let’s visualize!.</p>
</div>
<div id="visualizing-sharpe-ratios" class="section level3 unnumbered">
<h3>Visualizing Sharpe Ratios</h3>
<p>First, we will get a sense for what proportion of our portfolio returns exceeded the risk-free rate.</p>
<p>When we originally calculated Sharpe by-hand in the tidy world, we used <code>summarise</code> to create one new cell for our end result. The code was <code>summarise(ratio = mean(returns - rfr)/sd(returns - rfr))</code>.</p>
<p>Now, we will make two additions to assist in our data visualization. We will add a column for returns that fall below the risk-free rate with <code>mutate(returns_below_rfr = ifelse(returns &lt; rfr, returns, NA))</code> and add a column for returns above the risk-free rate with <code>mutate(returns_above_rfr = ifelse(returns &gt; rfr, returns, NA))</code>.</p>
<p>This is not necessary for calculating the Sharpe Ratio, but we will see how it makes our ggplotting a bit easier and it illustrates a benefit of doing things by-hand with <code>dplyr</code>: if we want to extract or create certain data tranformations, we can add it to the piped code flow.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_byhand_with_return_columns &lt;-<span class="st"> </span>
<span class="st">  </span>portfolio_returns_tq_rebalanced_monthly <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ratio =</span> <span class="kw">mean</span>(returns <span class="op">-</span><span class="st"> </span>rfr)<span class="op">/</span><span class="kw">sd</span>(returns <span class="op">-</span><span class="st"> </span>rfr)) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">returns_below_rfr =</span> <span class="kw">ifelse</span>(returns <span class="op">&lt;</span><span class="st"> </span>rfr, returns, <span class="ot">NA</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">returns_above_rfr =</span> <span class="kw">ifelse</span>(returns <span class="op">&gt;</span><span class="st"> </span>rfr, returns, <span class="ot">NA</span>))</code></pre></div>
<p>Let’s start with a scatterplot of returns using <code>ggplot</code>.</p>
<p>The goal is to quickly grasp how many of our returns are above the rfr and how many are below the rfr.</p>
<p>We will create green points for returns above rfr with <code>geom_point(aes(y = returns_above_rfr), colour = &quot;green&quot;)</code> and red points for returns below rfr with <code>geom_point(aes(y = returns_below_rfr), colour = &quot;red&quot;)</code>.</p>
<p>I’m always curious how portfolios have performed since the election so we’ll add a blue vertical line at November of 2016. We will also include a horizontal purple dotted line at the rfr.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_byhand_with_return_columns <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> returns_below_rfr), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> returns_above_rfr), <span class="dt">colour =</span> <span class="st">&quot;green&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="kw">as.numeric</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2016-11-30&quot;</span>)), <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> rfr, <span class="dt">color =</span> <span class="st">&quot;purple&quot;</span>, <span class="dt">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="kw">as.Date</span>(<span class="st">&quot;2016-11-30&quot;</span>), 
           <span class="dt">y =</span> <span class="op">-</span>.<span class="dv">04</span>, <span class="dt">label =</span> <span class="st">&quot;Election&quot;</span>, <span class="dt">fontface =</span> <span class="st">&quot;plain&quot;</span>, 
           <span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">alpha =</span> .<span class="dv">5</span>, <span class="dt">vjust =</span>  <span class="fl">1.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;percent monthly returns&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="kw">pretty_breaks</span>(<span class="dt">n =</span> <span class="dv">10</span>))</code></pre></div>
<p><img src="bookdown_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Next we will build a histogram of the distribution of returns with <code>geom_histogram(alpha = 0.25, binwidth = .01, fill = &quot;cornflowerblue&quot;)</code>. We will again add a line for the risk-free rate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_byhand_with_return_columns <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> returns)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">alpha =</span> <span class="fl">0.25</span>, <span class="dt">binwidth =</span> .<span class="dv">01</span>, <span class="dt">fill =</span> <span class="st">&quot;cornflowerblue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> rfr, <span class="dt">color =</span> <span class="st">&quot;green&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> rfr,
    <span class="dt">y =</span> <span class="dv">15</span>, <span class="dt">label =</span> <span class="st">&quot;rfr&quot;</span>, <span class="dt">fontface =</span> <span class="st">&quot;plain&quot;</span>, <span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">alpha =</span> .<span class="dv">5</span>, <span class="dt">vjust =</span>  <span class="dv">1</span>)</code></pre></div>
<p><img src="bookdown_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Interesting to see the distribution of returns in comparison to the risk-free rate, but we have not visualized the actual Sharpe Ratio yet. We will do so now.</p>
<p>The ratio itself is one number. Similar to the standard deviation, skewness and kurtosis of returns, that doesn’t allow much by way of dynamic visualization and it might obscure important periods of fluctutation in our data. We can solve that by working with the rolling Sharpe Ratio.</p>
</div>
<div id="rolling-sharpe-ratio-in-the-xts-world" class="section level3 unnumbered">
<h3>Rolling Sharpe Ratio in the <code>xts</code> World</h3>
<p>First, we need to calculate the rolling 6-month Sharpe Ratio with <code>rollapply(portfolio_returns_xts_rebalanced_monthly, 6, function(x) SharpeRatio(x, Rf = rfr, FUN = &quot;StdDev&quot;))</code>.</p>
<p>Note that we need to pass in the argument <code>FUN = &quot;StdDev&quot;</code>. Try running the code without that argument check out the error.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">window &lt;-<span class="st"> </span><span class="dv">6</span>

rolling_sharpe_xts &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">rollapply</span>(portfolio_returns_xts_rebalanced_monthly, window, 
            <span class="cf">function</span>(x) <span class="kw">SharpeRatio</span>(x, <span class="dt">Rf =</span> rfr, <span class="dt">FUN =</span> <span class="st">&quot;StdDev&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  `</span><span class="dt">colnames&lt;-</span><span class="st">`</span>(<span class="st">&quot;sharpe&quot;</span>)</code></pre></div>
</div>
<div id="rolling-sharpe-ratio-with-tidyverse-tibbletime" class="section level3 unnumbered">
<h3>Rolling Sharpe Ratio with Tidyverse + Tibbletime</h3>
<p>Similar to what we did with the standard deviation, we can combine the tidyverse and tibbletime to run the rolling Sharpe Ratio calculation on our data frame.</p>
<p>Here we are going to write our own function with <code>rollify()</code>, but it’s the same function we used above to find the Sharpe Ratio, <code>ratio = mean(returns - rfr)/sd(returns - rfr)</code>. Notice we still pass in our <code>rfr</code> and <code>window</code> variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tibbletime)

sharpe_roll_<span class="dv">6</span> &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">rollify</span>(<span class="cf">function</span>(returns) {
    ratio =<span class="st"> </span><span class="kw">mean</span>(returns <span class="op">-</span><span class="st"> </span>rfr)<span class="op">/</span><span class="kw">sd</span>(returns <span class="op">-</span><span class="st"> </span>rfr)
    }, 
<span class="dt">window =</span> window)
  
  
rolling_sharpe_tidy_tibbletime &lt;-<span class="st"> </span>
<span class="st">  </span>portfolio_returns_tq_rebalanced_monthly <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">as_tbl_time</span>(<span class="dt">index =</span> date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ratio =</span> <span class="kw">sharpe_roll_6</span>(returns)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>returns)</code></pre></div>
<p>Let’s compare our objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(rolling_sharpe_tidy_tibbletime)</code></pre></div>
<pre><code>## # A time tibble: 6 x 2
## # Index: date
##   date       ratio
##   &lt;date&gt;     &lt;dbl&gt;
## 1 2013-07-31 0.363
## 2 2013-08-31 0.156
## 3 2013-09-30 0.301
## 4 2013-10-31 0.359
## 5 2013-11-30 0.477
## 6 2013-12-31 0.786</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(rolling_sharpe_xts)</code></pre></div>
<pre><code>##               sharpe
## 2013-07-31 0.3626407
## 2013-08-30 0.1555792
## 2013-09-30 0.3010784
## 2013-10-31 0.3585765
## 2013-11-29 0.4772118
## 2013-12-31 0.7860678</code></pre>
</div>
<div id="visualizing-the-rolling-sharpe-ratio" class="section level3 unnumbered">
<h3>Visualizing the Rolling Sharpe Ratio</h3>
<p>Let’s start with <code>highcharter</code> and investigate any unusual occurrences.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">highchart</span>(<span class="dt">type =</span> <span class="st">&quot;stock&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_title</span>(<span class="dt">text =</span> <span class="st">&quot;Rolling Sharpe&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(rolling_sharpe_xts, <span class="dt">name =</span> <span class="st">&quot;sharpe&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_navigator</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">hc_scrollbar</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div id="htmlwidget-4f5f869aae3114187633" style="width:100%;height:500px;" class="highchart html-widget"></div>
<script type="application/json" data-for="htmlwidget-4f5f869aae3114187633">{"x":{"hc_opts":{"title":{"text":"Rolling Sharpe"},"yAxis":{"title":{"text":null}},"credits":{"enabled":false},"exporting":{"enabled":false},"plotOptions":{"series":{"turboThreshold":0},"treemap":{"layoutAlgorithm":"squarified"},"bubble":{"minSize":5,"maxSize":25}},"annotationsOptions":{"enabledButtons":false},"tooltip":{"delayForDisplay":10},"series":[{"data":[[1375228800000,0.362640716817881],[1377820800000,0.155579159664142],[1380499200000,0.301078400251772],[1383177600000,0.35857652896531],[1385683200000,0.47721180224057],[1388448000000,0.786067752840673],[1391126400000,0.202509893390402],[1393545600000,0.53012872246474],[1396224000000,0.373814508519869],[1398816000000,0.21942725978291],[1401408000000,0.228251785410328],[1404086400000,0.26274332472236],[1406764800000,0.62731387297077],[1409270400000,0.619449238711699],[1412035200000,0.0290739731448359],[1414713600000,0.142266431884237],[1417132800000,0.0695618863336238],[1419984000000,-0.139789782381564],[1422576000000,-0.129982068710836],[1424995200000,0.0116398773807724],[1427760000000,0.242561364481041],[1430352000000,0.230683894647058],[1432857600000,0.167578179528151],[1435622400000,0.126668449965385],[1438300800000,0.19347396731715],[1440979200000,-0.496296226952782],[1443571200000,-0.616697915188308],[1446163200000,-0.259614111561776],[1448841600000,-0.250937581952001],[1451520000000,-0.284944617491356],[1454025600000,-0.423383854005559],[1456704000000,-0.235668009504409],[1459382400000,0.174084482769758],[1461888000000,0.006661270993218],[1464652800000,0.00259774665375221],[1467244800000,0.152493016293535],[1469750400000,0.666057329601035],[1472601600000,0.761621553878001],[1475193600000,0.80303099924037],[1477872000000,0.323485403401499],[1480464000000,0.503148677100754],[1483056000000,0.588413306073652],[1485820800000,0.560948817924757],[1488240000000,0.692775168486836],[1490918400000,0.734127641628649],[1493337600000,4.96565832397694],[1496188800000,4.38402152985896],[1498780800000,3.26380156697544],[1501459200000,2.99297336132539],[1504137600000,1.61838204306583],[1506643200000,1.52278069689687],[1509408000000,1.5854067471237],[1512000000000,1.62178968873202],[1514505600000,1.74099244387776]],"name":"sharpe","color":"blue"}],"navigator":{"enabled":false},"scrollbar":{"enabled":false}},"theme":{"chart":{"backgroundColor":"transparent"}},"conf_opts":{"global":{"Date":null,"VMLRadialGradientURL":"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png","canvasToolsURL":"http =//code.highcharts.com/list(version)/modules/canvas-tools.js","getTimezoneOffset":null,"timezoneOffset":0,"useUTC":true},"lang":{"contextButtonTitle":"Chart context menu","decimalPoint":".","downloadJPEG":"Download JPEG image","downloadPDF":"Download PDF document","downloadPNG":"Download PNG image","downloadSVG":"Download SVG vector image","drillUpText":"Back to {series.name}","invalidDate":null,"loading":"Loading...","months":["January","February","March","April","May","June","July","August","September","October","November","December"],"noData":"No data to display","numericSymbols":["k","M","G","T","P","E"],"printChart":"Print chart","resetZoom":"Reset zoom","resetZoomTitle":"Reset zoom level 1:1","shortMonths":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"thousandsSep":" ","weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]}},"type":"stock","fonts":[],"debug":false},"evals":[],"jsHooks":[]}</script>
<p>A huge spike in 2017! Recall that the rolling contribution to volatility of EEM spiked in 2017 as well. There seems to be something afoot during those first six-months.</p>
<p>Let’s see how the rolling 12-month compares and whether it smooths out these spikes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_roll_12_xts &lt;-<span class="st"> </span><span class="kw">rollapply</span>(portfolio_returns_xts_rebalanced_monthly, <span class="dv">12</span>, 
                           <span class="cf">function</span>(x) <span class="kw">SharpeRatio</span>(x, <span class="dt">Rf =</span> rfr, <span class="dt">FUN =</span> <span class="st">&quot;StdDev&quot;</span>))

<span class="kw">highchart</span>(<span class="dt">type =</span> <span class="st">&quot;stock&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_title</span>(<span class="dt">text =</span> <span class="st">&quot;Rolling sharpe&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(sharpe_roll_12_xts, <span class="dt">name =</span> <span class="st">&quot;sharpe 24&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;lightgreen&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_navigator</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">hc_scrollbar</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div id="htmlwidget-de701fe97f7c26936c48" style="width:100%;height:500px;" class="highchart html-widget"></div>
<script type="application/json" data-for="htmlwidget-de701fe97f7c26936c48">{"x":{"hc_opts":{"title":{"text":"Rolling sharpe"},"yAxis":{"title":{"text":null}},"credits":{"enabled":false},"exporting":{"enabled":false},"plotOptions":{"series":{"turboThreshold":0},"treemap":{"layoutAlgorithm":"squarified"},"bubble":{"minSize":5,"maxSize":25}},"annotationsOptions":{"enabledButtons":false},"tooltip":{"delayForDisplay":10},"series":[{"data":[[1362009600000,null],[1364428800000,null],[1367280000000,null],[1369958400000,null],[1372377600000,null],[1375228800000,null],[1377820800000,null],[1380499200000,null],[1383177600000,null],[1385683200000,null],[1388448000000,null],[1391126400000,0.267890987954335],[1393545600000,0.371754167973103],[1396224000000,0.352060905532997],[1398816000000,0.306907677650475],[1401408000000,0.373663817592456],[1404086400000,0.524315643364595],[1406764800000,0.348776231249635],[1409270400000,0.535833140288388],[1412035200000,0.220569755979616],[1414713600000,0.190185096114986],[1417132800000,0.158266969896467],[1419984000000,0.0747037614399565],[1422576000000,0.191728690886504],[1424995200000,0.205184869234268],[1427760000000,0.138595405539181],[1430352000000,0.1923863345621],[1432857600000,0.122136230581428],[1435622400000,-0.00746617429975985],[1438300800000,0.0287883091171052],[1440979200000,-0.227679830690179],[1443571200000,-0.202253047550502],[1446163200000,-0.0746728952135152],[1448841600000,-0.0923119556245488],[1451520000000,-0.126780413703895],[1454025600000,-0.191983987251926],[1456704000000,-0.356107484088748],[1459382400000,-0.110104420770124],[1461888000000,-0.129592254121549],[1464652800000,-0.127500565977068],[1467244800000,-0.0731781661512443],[1469750400000,0.0226625021778926],[1472601600000,0.182851854871561],[1475193600000,0.291050758694058],[1477872000000,0.104165247959684],[1480464000000,0.154675775238951],[1483056000000,0.291897166753875],[1485820800000,0.60694898629884],[1488240000000,0.716849355580586],[1490918400000,0.80320062008771],[1493337600000,0.814168246426689],[1496188800000,0.959304006629322],[1498780800000,0.982427830965862],[1501459200000,1.04685908731818],[1504137600000,0.984629583365629],[1506643200000,1.04097850437054],[1509408000000,2.33208662908385],[1512000000000,2.30773804685516],[1514505600000,2.24418239820205]],"name":"sharpe 24","color":"lightgreen"}],"navigator":{"enabled":false},"scrollbar":{"enabled":false}},"theme":{"chart":{"backgroundColor":"transparent"}},"conf_opts":{"global":{"Date":null,"VMLRadialGradientURL":"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png","canvasToolsURL":"http =//code.highcharts.com/list(version)/modules/canvas-tools.js","getTimezoneOffset":null,"timezoneOffset":0,"useUTC":true},"lang":{"contextButtonTitle":"Chart context menu","decimalPoint":".","downloadJPEG":"Download JPEG image","downloadPDF":"Download PDF document","downloadPNG":"Download PNG image","downloadSVG":"Download SVG vector image","drillUpText":"Back to {series.name}","invalidDate":null,"loading":"Loading...","months":["January","February","March","April","May","June","July","August","September","October","November","December"],"noData":"No data to display","numericSymbols":["k","M","G","T","P","E"],"printChart":"Print chart","resetZoom":"Reset zoom","resetZoomTitle":"Reset zoom level 1:1","shortMonths":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"thousandsSep":" ","weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]}},"type":"stock","fonts":[],"debug":false},"evals":[],"jsHooks":[]}</script>
<p>There’s still a spike in 2017 but of a smaller magnitude.</p>
<p>If we wish to visualize rolling Sharpe with <code>ggplot</code>, we can convert that xts object to a data frame and then pipe on through.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sharpe_roll_12_xts <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">tk_tbl</span>(<span class="dt">preserve_index =</span> <span class="ot">TRUE</span>, <span class="dt">rename_index =</span> <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">rolling_sharpe =</span> returns) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> rolling_sharpe)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;cornflowerblue&quot;</span>)</code></pre></div>
<pre><code>## Warning: Removed 11 rows containing missing values (geom_path).</code></pre>
<p><img src="bookdown_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Those rolling charts certainly make our portfolio look attractive but remember, it actually had a lower Sharpe Ratio than the S&amp;P500 over this time period! Let’s compare their rolling ratios.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">market_sharpe_roll_12_xts &lt;-<span class="st"> </span><span class="kw">rollapply</span>(market_returns_xts, <span class="dv">12</span>, 
                           <span class="cf">function</span>(x) <span class="kw">SharpeRatio</span>(x, <span class="dt">Rf =</span> rfr, <span class="dt">FUN =</span> <span class="st">&quot;StdDev&quot;</span>))
  

<span class="kw">highchart</span>(<span class="dt">type =</span> <span class="st">&quot;stock&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_title</span>(<span class="dt">text =</span> <span class="st">&quot;Rolling sharpe&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(sharpe_roll_12_xts, <span class="dt">name =</span> <span class="st">&quot;Portfolio&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;cornflowerblue&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(market_sharpe_roll_12_xts, <span class="dt">name =</span> <span class="st">&quot;SP500&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;green&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_navigator</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">hc_scrollbar</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div id="htmlwidget-ab70dfe4b52073c34392" style="width:100%;height:500px;" class="highchart html-widget"></div>
<script type="application/json" data-for="htmlwidget-ab70dfe4b52073c34392">{"x":{"hc_opts":{"title":{"text":"Rolling sharpe"},"yAxis":{"title":{"text":null}},"credits":{"enabled":false},"exporting":{"enabled":false},"plotOptions":{"series":{"turboThreshold":0},"treemap":{"layoutAlgorithm":"squarified"},"bubble":{"minSize":5,"maxSize":25}},"annotationsOptions":{"enabledButtons":false},"tooltip":{"delayForDisplay":10},"series":[{"data":[[1362009600000,null],[1364428800000,null],[1367280000000,null],[1369958400000,null],[1372377600000,null],[1375228800000,null],[1377820800000,null],[1380499200000,null],[1383177600000,null],[1385683200000,null],[1388448000000,null],[1391126400000,0.267890987954335],[1393545600000,0.371754167973103],[1396224000000,0.352060905532997],[1398816000000,0.306907677650475],[1401408000000,0.373663817592456],[1404086400000,0.524315643364595],[1406764800000,0.348776231249635],[1409270400000,0.535833140288388],[1412035200000,0.220569755979616],[1414713600000,0.190185096114986],[1417132800000,0.158266969896467],[1419984000000,0.0747037614399565],[1422576000000,0.191728690886504],[1424995200000,0.205184869234268],[1427760000000,0.138595405539181],[1430352000000,0.1923863345621],[1432857600000,0.122136230581428],[1435622400000,-0.00746617429975985],[1438300800000,0.0287883091171052],[1440979200000,-0.227679830690179],[1443571200000,-0.202253047550502],[1446163200000,-0.0746728952135152],[1448841600000,-0.0923119556245488],[1451520000000,-0.126780413703895],[1454025600000,-0.191983987251926],[1456704000000,-0.356107484088748],[1459382400000,-0.110104420770124],[1461888000000,-0.129592254121549],[1464652800000,-0.127500565977068],[1467244800000,-0.0731781661512443],[1469750400000,0.0226625021778926],[1472601600000,0.182851854871561],[1475193600000,0.291050758694058],[1477872000000,0.104165247959684],[1480464000000,0.154675775238951],[1483056000000,0.291897166753875],[1485820800000,0.60694898629884],[1488240000000,0.716849355580586],[1490918400000,0.80320062008771],[1493337600000,0.814168246426689],[1496188800000,0.959304006629322],[1498780800000,0.982427830965862],[1501459200000,1.04685908731818],[1504137600000,0.984629583365629],[1506643200000,1.04097850437054],[1509408000000,2.33208662908385],[1512000000000,2.30773804685516],[1514505600000,2.24418239820205]],"name":"Portfolio","color":"cornflowerblue"},{"data":[[1359590400000,null],[1362009600000,null],[1364428800000,null],[1367280000000,null],[1369958400000,null],[1372377600000,null],[1375228800000,null],[1377820800000,null],[1380499200000,null],[1383177600000,null],[1385683200000,null],[1388448000000,13.8429220710517],[1391126400000,14.7995540545755],[1393545600000,15.18378293544],[1396224000000,15.2955028361378],[1398816000000,15.6118298313085],[1401408000000,15.4436893604458],[1404086400000,16.1207511814707],[1406764800000,16.6366227186244],[1409270400000,18.3539416572072],[1412035200000,21.4763030918626],[1414713600000,22.2921545924548],[1417132800000,20.9233651622693],[1419984000000,20.1125305265565],[1422576000000,24.4655339848678],[1424995200000,23.7519510822279],[1427760000000,25.5567525898953],[1430352000000,28.1848604825053],[1432857600000,29.2372023332333],[1435622400000,31.4496153399332],[1438300800000,36.9042165600381],[1440979200000,37.4222333828761],[1443571200000,35.7143747226227],[1446163200000,35.9675674299112],[1448841600000,34.7802392368787],[1451520000000,34.8300003812978],[1454025600000,33.5820612524457],[1456704000000,31.3292931004277],[1459382400000,30.6572341838889],[1461888000000,30.0823147825368],[1464652800000,28.844548996842],[1467244800000,27.0076597867007],[1469750400000,23.1559033360145],[1472601600000,21.8454077499214],[1475193600000,23.640824192832],[1477872000000,23.1139112840068],[1480464000000,21.1438998625082],[1483056000000,19.4436639018971],[1485820800000,20.3996113332454],[1488240000000,20.9487386825682],[1490918400000,19.5939655472302],[1493337600000,19.094468778767],[1496188800000,18.4874826663256],[1498780800000,18.7151379443435],[1501459200000,17.7236182237281],[1504137600000,17.6197524921945],[1506643200000,17.7189261554064],[1509408000000,19.1082090457805],[1512000000000,18.6167520413388],[1514505600000,18.3094625578032]],"name":"SP500","color":"green"}],"navigator":{"enabled":false},"scrollbar":{"enabled":false}},"theme":{"chart":{"backgroundColor":"transparent"}},"conf_opts":{"global":{"Date":null,"VMLRadialGradientURL":"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png","canvasToolsURL":"http =//code.highcharts.com/list(version)/modules/canvas-tools.js","getTimezoneOffset":null,"timezoneOffset":0,"useUTC":true},"lang":{"contextButtonTitle":"Chart context menu","decimalPoint":".","downloadJPEG":"Download JPEG image","downloadPDF":"Download PDF document","downloadPNG":"Download PNG image","downloadSVG":"Download SVG vector image","drillUpText":"Back to {series.name}","invalidDate":null,"loading":"Loading...","months":["January","February","March","April","May","June","July","August","September","October","November","December"],"noData":"No data to display","numericSymbols":["k","M","G","T","P","E"],"printChart":"Print chart","resetZoom":"Reset zoom","resetZoomTitle":"Reset zoom level 1:1","shortMonths":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"thousandsSep":" ","weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]}},"type":"stock","fonts":[],"debug":false},"evals":[],"jsHooks":[]}</script>
<p>It seems our portfolio underperformed early and outperformed late. Let’s head to Shiny so end users (and ourselves) can build more interesting portfolios and compare to the S&amp;P500.</p>
</div>
<div id="shiny-for-sharpe-ratio" class="section level3 unnumbered">
<h3>Shiny for Sharpe Ratio</h3>
<p>On to Shiny and we will stick with our standard template but add a few aesthetics/best practices.</p>
<p>Have a quick look at the final app here:</p>
<p>www.reproduciblefinance.com/shiny/sharpe-ratio/</p>
<p>And here is a snapshot</p>
<div class="figure"><span id="fig:unnamed-chunk-19"></span>
<img src="snapshots/sharpe-app.png" alt="Sharpe Ratio Shiny App" width="100%" />
<p class="caption">
FIGURE 2.1: Sharpe Ratio Shiny App
</p>
</div>
<p>Notice that we have added two blue value boxes to display the portfolio and market Sharpe Ratios over whatever time period the end user has selected. Do you like those? Despise them? We’ll run through how to build them anyway.</p>
<p>Additionally, try setting the asset weights to a number that does not equal 100 and see the error message. We will review how to add these below.</p>
<p>But, first, our input sidebar is our standard except the user can choose a risk-free rate. I’ve chosen to handle that by letting the user enter his or her own number but imagine other methods like the ability to choose a T-bill rate. Or perhaps we feel that the risk-free rate should be set and not changeable because it changes how the end user perceives a portfolio so much.</p>
<p>Here we use <code>numericInput(&quot;rfr&quot;, &quot;RFR&quot;, .0003, min = 0, max = 1, step = .0002)</code> to let the user choose a risk-free rate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">numericInput</span>(<span class="st">&quot;rfr&quot;</span>, <span class="st">&quot;RFR&quot;</span>, .<span class="dv">0003</span>, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>, <span class="dt">step =</span> .<span class="dv">0002</span>)</code></pre></div>
<p>Now we follow our same flows from above to calculate the rolling Sharpe Ratio.</p>
<p>First, let’s assign our risk-free rate and rolling window objects. We also save the <code>prices</code> object as we have done in our previous apps.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rfr &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {input<span class="op">$</span>rfr<span class="op">/</span><span class="dv">100</span>})

window &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {input<span class="op">$</span>window})</code></pre></div>
<p>Note that we ask for a risk-free rate <em>percent</em>. Thus, when calculating the reactive, we divide by 100.</p>
<p>Next, we call a reactive to calculate the rolling Sharpe Ratio.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rolling_portfolio_sharpe_xts &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {
  
  <span class="kw">validate</span>(<span class="kw">need</span>(input<span class="op">$</span>w1 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w2 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w3 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w4 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w5 <span class="op">==</span><span class="st"> </span><span class="dv">100</span>, 
                <span class="st">&quot;The portfolio weights must sum to 100%!&quot;</span>))
  
  prices &lt;-<span class="st"> </span><span class="kw">prices</span>()
  
  w &lt;-<span class="st"> </span><span class="kw">c</span>(input<span class="op">$</span>w1<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w2<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w3<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w4<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w5<span class="op">/</span><span class="dv">100</span>)
  
  rfr &lt;-<span class="st"> </span><span class="kw">rfr</span>()
  
  window &lt;-<span class="st"> </span><span class="kw">window</span>()

prices_monthly &lt;-<span class="st"> </span><span class="kw">to.monthly</span>(prices, <span class="dt">indexAt =</span> <span class="st">&quot;last&quot;</span>, <span class="dt">OHLC =</span> <span class="ot">FALSE</span>)
asset_returns_xts &lt;-<span class="st"> </span><span class="kw">na.omit</span>(<span class="kw">Return.calculate</span>(prices_monthly, <span class="dt">method =</span> <span class="st">&quot;log&quot;</span>))

portfolio_returns_xts_rebalanced_monthly &lt;-<span class="st"> </span><span class="kw">Return.portfolio</span>(asset_returns_xts, <span class="dt">weights =</span> w, <span class="dt">rebalance_on =</span> <span class="st">&quot;months&quot;</span>)

rolling_sharpe &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">rollapply</span>(portfolio_returns_xts_rebalanced_monthly, window, 
                           <span class="cf">function</span>(x) <span class="kw">SharpeRatio</span>(x, <span class="dt">Rf =</span> rfr, <span class="dt">FUN =</span> <span class="st">&quot;StdDev&quot;</span>))
})</code></pre></div>
<p>Note one crucial line in the above reactive, <code>validate(need(input$w1 + input$w2 + input$w3 + input$w4 + input$w5 == 100, &quot;The portfolio weights must sum to 100%!&quot;))</code>. This is where we ensure that the weights sum to 100. Toggle over to the live app and see what happens when the weights don’t sum to 100.</p>
<div class="figure"><span id="fig:unnamed-chunk-23"></span>
<img src="snapshots/sharpe-error.png" alt="Weights Error Message" width="100%" />
<p class="caption">
FIGURE 2.2: Weights Error Message
</p>
</div>
<p>We haven’t included that in any of our previous apps - because we were introducing new concepts and didn’t want to clutter the code - but it’s a good idea to include any time the user is choosing weights.</p>
<p>Now let’s get the Sharpe Ratio stored in a data frame. We’ll use the same object to hold the Sharpe Ratio and returns, same as we did above. This will allow us to use one object in multiple places.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">portfolio_sharpe &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {
  
  <span class="kw">validate</span>(<span class="kw">need</span>(input<span class="op">$</span>w1 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w2 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w3 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w4 <span class="op">+</span><span class="st"> </span>input<span class="op">$</span>w5 <span class="op">==</span><span class="st"> </span><span class="dv">100</span>, <span class="st">&quot;The portfolio weights must sum to 100%!&quot;</span>))
  
  prices &lt;-<span class="st"> </span><span class="kw">prices</span>()
  w &lt;-<span class="st"> </span><span class="kw">c</span>(input<span class="op">$</span>w1<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w2<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w3<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w4<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w5<span class="op">/</span><span class="dv">100</span>)
  
  rfr &lt;-<span class="st"> </span><span class="kw">rfr</span>()
  
  portfolio_returns_sharpe &lt;-<span class="st"> </span>
<span class="st">      </span>prices <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">to.monthly</span>(<span class="dt">indexAt =</span> <span class="st">&quot;last&quot;</span>, <span class="dt">OHLC =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">tk_tbl</span>(<span class="dt">preserve_index =</span> <span class="ot">TRUE</span>, <span class="dt">rename_index =</span> <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">gather</span>(asset, returns, <span class="op">-</span>date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(asset) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">returns =</span> (<span class="kw">log</span>(returns) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="kw">lag</span>(returns)))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">tq_portfolio</span>(<span class="dt">assets_col =</span> asset, 
               <span class="dt">returns_col =</span> returns, 
               <span class="dt">weights =</span> w,
               <span class="dt">col_rename =</span> <span class="st">&quot;returns&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">slice</span>(<span class="op">-</span><span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">ratio =</span> <span class="kw">mean</span>(returns <span class="op">-</span><span class="st"> </span>rfr)<span class="op">/</span><span class="kw">sd</span>(returns <span class="op">-</span><span class="st"> </span>rfr),
         <span class="dt">returns_below_rfr =</span> <span class="kw">ifelse</span>(returns <span class="op">&lt;</span><span class="st"> </span>rfr, returns, <span class="ot">NA</span>),
         <span class="dt">returns_above_rfr =</span> <span class="kw">ifelse</span>(returns <span class="op">&gt;</span><span class="st"> </span>rfr, returns, <span class="ot">NA</span>))

})</code></pre></div>
<p>I like being able to compare to the S&amp;P500 Sharpe, so we’ll also calculate and chart that. The market Sharpe has to be an interactive as well because it still depends on the start date and rolling window chosen by the end user.</p>
<p>Have a look at the code chunk below and notice that we save both the market returns and the overall market Sharpe Ratio by using <code>mutate()</code> twice:</p>
<p><code>mutate(returns = (log(SPY) - log(lag(SPY))))</code></p>
<p><code>mutate(market_sharpe = mean(returns - rfr)/sd(returns - rfr))</code>.</p>
<p>We will use the <code>market_sharpe</code> column in a <code>valueBox()</code> to print the overall market Sharpe Ratio. We will use the <code>returns</code> column to calculate the rolling market Sharpe for charting with <code>Highcharter()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">market_returns_sharpe &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {
  rfr &lt;-<span class="st"> </span><span class="kw">rfr</span>()
  
  market_returns_sharpe &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">getSymbols</span>(<span class="st">&quot;SPY&quot;</span>, <span class="dt">src =</span> <span class="st">&#39;yahoo&#39;</span>, <span class="dt">from =</span> input<span class="op">$</span>date, 
             <span class="dt">auto.assign =</span> <span class="ot">TRUE</span>, <span class="dt">warnings =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">Ad</span>(<span class="kw">get</span>(.))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">reduce</span>(merge) <span class="op">%&gt;%</span>
<span class="st">    `</span><span class="dt">colnames&lt;-</span><span class="st">`</span>(<span class="st">&quot;SPY&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">to.monthly</span>(<span class="dt">indexAt =</span> <span class="st">&quot;last&quot;</span>, <span class="dt">OHLC =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">tk_tbl</span>(<span class="dt">preserve_index =</span> <span class="ot">TRUE</span>, <span class="dt">rename_index =</span> <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">returns =</span> (<span class="kw">log</span>(SPY) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="kw">lag</span>(SPY)))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">market_sharpe =</span> <span class="kw">mean</span>(returns <span class="op">-</span><span class="st"> </span>rfr)<span class="op">/</span><span class="kw">sd</span>(returns <span class="op">-</span><span class="st"> </span>rfr))
  
})</code></pre></div>
<p>Let’s see how we include the rolling market Sharpe in our time series. First, have a look at the full code chunk:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">renderHighchart</span>({
  
  <span class="kw">validate</span>(<span class="kw">need</span>(input<span class="op">$</span>go <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Please choose your portfolio assets, weights, rfr, rolling window and start date and click submit.&quot;</span>))
  
  rfr &lt;-<span class="st"> </span><span class="kw">rfr</span>()
  window &lt;-<span class="st"> </span><span class="kw">window</span>()
  
  market_returns_xts &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">market_returns_sharpe</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(date, returns) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">tk_xts</span>(<span class="dt">date_var =</span> date)
  
  rolling_market_sharpe_xts &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">rollapply</span>(market_returns_xts, <span class="kw">window</span>(), 
                           <span class="cf">function</span>(x) <span class="kw">SharpeRatio</span>(x, <span class="dt">Rf =</span> rfr, <span class="dt">FUN =</span> <span class="st">&quot;StdDev&quot;</span>))
  
  <span class="kw">highchart</span>(<span class="dt">type =</span> <span class="st">&quot;stock&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_title</span>(<span class="dt">text =</span> <span class="st">&quot;Rolling Sharpe&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(<span class="kw">rolling_portfolio_sharpe_xts</span>(), <span class="dt">name =</span> <span class="st">&quot;Portfolio&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;cornflowerblue&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(rolling_market_sharpe_xts, <span class="dt">name =</span> <span class="st">&quot;Market&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;green&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_navigator</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">hc_scrollbar</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>) 

})</code></pre></div>
<p>Before calling the <code>highchart()</code> function, we transform our tidy, data frame market returns to an <code>xts</code> object with <code>market_returns_xts &lt;- market_returns_sharpe() %&gt;% select(date, returns) %&gt;% tk_xts(date_var = date)</code>.</p>
<p>Then we calculate the rolling ratio with <code>rolling_market_sharpe_xts &lt;- rollapply(market_returns_xts, window(), function(x) SharpeRatio(x, Rf = rfr, FUN = &quot;StdDev&quot;))</code>.</p>
<p>We now have two rolling Sharpe Ratio objects. <code>rolling_market_sharpe_xts</code> holds the market rolling ratio and <code>rolling_portfolio_sharpe_xts()</code> holds the portfolio rolling ratio that we calculated above. We could have calculated the rolling market numbers upstream with our other calculations, especially if we wanted the rolling numbers available elsewhere. But since there is no reason to do so, it’s a good idea to get familiar with another place to house calculations.</p>
<p>To complete that chunk breakdown, we then pass our two objects to <code>highchart()</code> with <code>hc_add_series(rolling_portfolio_sharpe_xts(), name = &quot;Portfolio&quot;, color = &quot;cornflowerblue&quot;)</code> and <code>hc_add_series(rolling_market_sharpe_xts, name = &quot;Market&quot;, color = &quot;green&quot;)</code>.</p>
<p>Our rolling visualizations are complete. Now let’s display the overall Sharpe Ratios with two <code>valueBox()</code> displays.</p>
<p>We call the <code>renderValueBox()</code> function, isolate the portfolio Sharpe Ratio with <code>portfolio_sharpe &lt;- portfolio_sharpe() %&gt;% summarise(ratio = round(mean(ratio), 4))</code> and then build with <code>valueBox(value = tags$p(portfolio_sharpe, style = &quot;font-size: 70%;&quot;), color = &quot;primary&quot;)</code>. This argument <code>style = &quot;font-size: 70%;&quot;</code> is purely to set the font size.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">renderValueBox</span>({
  
  portfolio_sharpe &lt;-<span class="st"> </span><span class="kw">portfolio_sharpe</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">ratio =</span> <span class="kw">round</span>(<span class="kw">mean</span>(ratio), <span class="dv">4</span>))
  <span class="kw">valueBox</span>(<span class="dt">value =</span> tags<span class="op">$</span><span class="kw">p</span>(portfolio_sharpe, <span class="dt">style =</span> <span class="st">&quot;font-size: 70%;&quot;</span>), <span class="dt">color =</span> <span class="st">&quot;primary&quot;</span>)
})</code></pre></div>
<p>Repeat the same for the market ratio.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">renderValueBox</span>({
  
  market_sharpe &lt;-<span class="st"> </span><span class="kw">market_returns_sharpe</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">ratio =</span> <span class="kw">round</span>(<span class="kw">mean</span>(market_sharpe), <span class="dv">4</span>))
  <span class="kw">valueBox</span>(<span class="dt">value =</span> tags<span class="op">$</span><span class="kw">p</span>(market_sharpe, <span class="dt">style =</span> <span class="st">&quot;font-size: 70%;&quot;</span>), <span class="dt">color =</span> <span class="st">&quot;primary&quot;</span>)
})</code></pre></div>
<p>After this, we add a scatterplot and histogram of returns distributions with the same code flow as has been used with our previous Shiny apps,</p>
<p>That’s a wrap for our work on the Sharpe Ratio. In the next Chapter, we will see a slight variation of this idea with the Sortino Ratio, and our work on Sharpe Ratios will come in handy.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="portfolio-theory.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sortino-ratio.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/yihui/bookdown-crc/edit/master/portfolio-theory.Rmd",
"text": "Edit"
},
"download": ["bookdown.pdf", "bookdown.epub"],
"toc": {
"collapse": "chapter"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
