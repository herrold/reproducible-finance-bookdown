<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Reproducible Finance with R</title>
  <meta name="description" content="A reproducible for Chapman &amp; Hall.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Reproducible Finance with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A reproducible for Chapman &amp; Hall." />
  <meta name="github-repo" content="jkr216/reproducible-finance-ch" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Reproducible Finance with R" />
  
  <meta name="twitter:description" content="A reproducible for Chapman &amp; Hall." />
  

<meta name="author" content="Jonathan K. Regenstein, Jr.">


<meta name="date" content="2018-01-17">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="component-contribution-to-volatility.html">
<link rel="next" href="portfolio-theory.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets/htmlwidgets.js"></script>
<script src="libs/proj4js/proj4.js"></script>
<link href="libs/highcharts/css/motion.css" rel="stylesheet" />
<script src="libs/highcharts/highstock.js"></script>
<script src="libs/highcharts/highcharts-3d.js"></script>
<script src="libs/highcharts/highcharts-more.js"></script>
<script src="libs/highcharts/modules/annotations.js"></script>
<script src="libs/highcharts/modules/broken-axis.js"></script>
<script src="libs/highcharts/modules/data.js"></script>
<script src="libs/highcharts/modules/drilldown.js"></script>
<script src="libs/highcharts/modules/exporting.js"></script>
<script src="libs/highcharts/modules/funnel.js"></script>
<script src="libs/highcharts/modules/heatmap.js"></script>
<script src="libs/highcharts/modules/map.js"></script>
<script src="libs/highcharts/modules/no-data-to-display.js"></script>
<script src="libs/highcharts/modules/offline-exporting.js"></script>
<script src="libs/highcharts/modules/solid-gauge.js"></script>
<script src="libs/highcharts/modules/treemap.js"></script>
<script src="libs/highcharts/plugins/annotations.js"></script>
<script src="libs/highcharts/plugins/draggable-legend.js"></script>
<script src="libs/highcharts/plugins/draggable-points.js"></script>
<script src="libs/highcharts/plugins/export-csv.js"></script>
<script src="libs/highcharts/plugins/grouped-categories.js"></script>
<script src="libs/highcharts/plugins/motion.js"></script>
<script src="libs/highcharts/plugins/pattern-fill-v2.js"></script>
<script src="libs/highcharts/plugins/tooltip-delay.js"></script>
<script src="libs/highcharts/custom/reset.js"></script>
<script src="libs/highcharts/custom/symbols-extra.js"></script>
<script src="libs/highcharts/custom/text-symbols.js"></script>
<link href="libs/fontawesome/font-awesome.min.css" rel="stylesheet" />
<link href="libs/htmlwdgtgrid/htmlwdgtgrid.css" rel="stylesheet" />
<script src="libs/highchart-binding/highchart.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> install the packages needed by this book; you fill out c(), e.g. c(‘ggplot2’, ‘dplyr’)</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-read-this-book"><i class="fa fa-check"></i>Why read this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#structure-of-the-book"><i class="fa fa-check"></i>Structure of the book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-author"><i class="fa fa-check"></i>About the Author</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#software-information-and-conventions"><i class="fa fa-check"></i>Software information and conventions</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgments"><i class="fa fa-check"></i>Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html"><i class="fa fa-check"></i>Returns</a><ul>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#importing-asset-prices"><i class="fa fa-check"></i>Importing Asset Prices</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#thoughts-on-converting-daily-prices-to-monthly-log-returns"><i class="fa fa-check"></i>Thoughts on Converting Daily Prices to Monthly Log Returns</a></li>
<li><a href="returns.html#converting-daily-prices-to-monthly-returns-in-the-xts-world">Converting Daily Prices to Monthly Returns in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#converting-daily-prices-to-monthly-returns-in-the-tidyverse"><i class="fa fa-check"></i>Converting Daily Prices to Monthly Returns in the Tidyverse</a></li>
<li><a href="returns.html#converting-daily-prices-to-monthly-returns-in-the-tidyquant-world">Converting Daily Prices to Monthly Returns in the <code>tidyquant</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#a-word-on-workflow-and-recap"><i class="fa fa-check"></i>A Word on workflow and recap</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#visualizing-asset-returns-before-they-get-mashed-into-a-portfolio"><i class="fa fa-check"></i>Visualizing Asset Returns before they get mashed into a portfolio</a></li>
<li><a href="returns.html#portfolio-returns-in-the-xts-world">Portfolio Returns in the <code>xts</code> world</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#portfolio-returns-in-the-tidyverse"><i class="fa fa-check"></i>Portfolio Returns in the tidyverse</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#portfolio-returns-in-the-tidyquant-world"><i class="fa fa-check"></i>Portfolio Returns in the tidyquant World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#visualizing-portfolio-returns"><i class="fa fa-check"></i>Visualizing Portfolio Returns</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#our-first-shiny-app-portfolio-returns"><i class="fa fa-check"></i>Our First Shiny App: Portfolio Returns</a></li>
<li><a href="returns.html#portfolio-growth-in-the-xts-world">Portfolio Growth in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#portfolio-growth-in-the-tidyverse"><i class="fa fa-check"></i>Portfolio Growth in the Tidyverse</a></li>
<li><a href="returns.html#portfolio-growth-in-the-tidyquant-world">Portfolio Growth in the <code>tidyquant</code> World</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#visualizing-portfolio-growth"><i class="fa fa-check"></i>Visualizing Portfolio Growth</a></li>
<li class="chapter" data-level="1.0.1" data-path="returns.html"><a href="returns.html#shiny-growth-of-a-dollar"><i class="fa fa-check"></i><b>1.0.1</b> Shiny Growth of a Dollar</a></li>
<li class="chapter" data-level="" data-path="returns.html"><a href="returns.html#concluding"><i class="fa fa-check"></i>Concluding</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="risk.html"><a href="risk.html"><i class="fa fa-check"></i>Risk</a></li>
<li class="chapter" data-level="2" data-path="portfolio-standard-deviation.html"><a href="portfolio-standard-deviation.html"><i class="fa fa-check"></i><b>2</b> Portfolio Standard Deviation</a><ul>
<li><a href="portfolio-standard-deviation.html#standard-deviation-in-the-xts-world">Standard Deviation in the <code>xts</code> World</a></li>
<li class="chapter" data-level="" data-path="portfolio-standard-deviation.html"><a href="portfolio-standard-deviation.html#standard-devation-in-the-tidyverse"><i class="fa fa-check"></i>Standard Devation in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="portfolio-standard-deviation.html"><a href="portfolio-standard-deviation.html#standard-deviation-in-the-tidyquant-world"><i class="fa fa-check"></i>Standard Deviation in the Tidyquant World</a></li>
<li class="chapter" data-level="" data-path="portfolio-standard-deviation.html"><a href="portfolio-standard-deviation.html#visualizing-standard-deviation"><i class="fa fa-check"></i>Visualizing Standard Deviation</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="rolling-standard-deviation.html"><a href="rolling-standard-deviation.html"><i class="fa fa-check"></i><b>3</b> Rolling Standard Deviation</a><ul>
<li class="chapter" data-level="3.0.1" data-path="rolling-standard-deviation.html"><a href="rolling-standard-deviation.html#rolling-standard-deviation-in-the-xts-world"><i class="fa fa-check"></i><b>3.0.1</b> Rolling Standard Deviation in the <code>xts</code> world</a></li>
<li class="chapter" data-level="3.0.2" data-path="rolling-standard-deviation.html"><a href="rolling-standard-deviation.html#rolling-standard-deviation-in-tidyverse"><i class="fa fa-check"></i><b>3.0.2</b> Rolling Standard Deviation in tidyverse</a></li>
<li class="chapter" data-level="" data-path="rolling-standard-deviation.html"><a href="rolling-standard-deviation.html#rolling-standard-deviation-with-tidyquant"><i class="fa fa-check"></i>Rolling Standard Deviation with tidyquant</a></li>
<li><a href="rolling-standard-deviation.html#visualizing-rolling-standard-deviation-in-the-xts-world">Visualizing Rolling Standard Deviation in the <code>xts</code> world</a></li>
<li class="chapter" data-level="" data-path="rolling-standard-deviation.html"><a href="rolling-standard-deviation.html#visualizing-rolling-standard-deviation-in-the-tidyverse"><i class="fa fa-check"></i>Visualizing Rolling Standard Deviation in the Tidyverse</a></li>
<li class="chapter" data-level="" data-path="rolling-standard-deviation.html"><a href="rolling-standard-deviation.html#shiny-app"><i class="fa fa-check"></i>Shiny App</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="component-contribution-to-volatility.html"><a href="component-contribution-to-volatility.html"><i class="fa fa-check"></i><b>4</b> Component Contribution to Volatility</a><ul>
<li class="chapter" data-level="" data-path="component-contribution-to-volatility.html"><a href="component-contribution-to-volatility.html#visualizing-component-contribution"><i class="fa fa-check"></i>Visualizing Component Contribution</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="rolling-component-contribution-to-volatility.html"><a href="rolling-component-contribution-to-volatility.html"><i class="fa fa-check"></i><b>5</b> Rolling Component Contribution to Volatility</a><ul>
<li class="chapter" data-level="" data-path="rolling-component-contribution-to-volatility.html"><a href="rolling-component-contribution-to-volatility.html#visualizing-component-contribution-to-volatility"><i class="fa fa-check"></i>Visualizing Component Contribution to Volatility</a></li>
<li class="chapter" data-level="" data-path="rolling-component-contribution-to-volatility.html"><a href="rolling-component-contribution-to-volatility.html#shiny-component-contribution"><i class="fa fa-check"></i>Shiny Component Contribution</a></li>
<li class="chapter" data-level="" data-path="rolling-component-contribution-to-volatility.html"><a href="rolling-component-contribution-to-volatility.html#conclusion-on-standard-deviation"><i class="fa fa-check"></i>Conclusion on Standard Deviation</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="portfolio-theory.html"><a href="portfolio-theory.html"><i class="fa fa-check"></i><b>6</b> Portfolio Theory</a></li>
<li class="chapter" data-level="7" data-path="montecarlo.html"><a href="montecarlo.html"><i class="fa fa-check"></i><b>7</b> montecarlo</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="more-to-say.html"><a href="more-to-say.html"><i class="fa fa-check"></i><b>A</b> More to Say</a></li>
<li class="chapter" data-level="" data-path="appendix-2.html"><a href="appendix-2.html"><i class="fa fa-check"></i>Appendix 2</a></li>
<li class="chapter" data-level="B" data-path="generate-a-bibtex-database-automatically-for-some-r-packages.html"><a href="generate-a-bibtex-database-automatically-for-some-r-packages.html"><i class="fa fa-check"></i><b>B</b> generate a BibTeX database automatically for some R packages</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reproducible Finance with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="rolling-component-contribution-to-volatility" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Rolling Component Contribution to Volatility</h1>
<p>Now we turn to our most involved task yet, to calculate the rolling volatility contribution of each asset. The previous section told us the total contribution of each asset over the life of the portfolio, but it did not help us understand risk components over time. As we discussed in our section on rolling portfolio volatility, there are reasons to care about rolling volatility and that means there are reasons to care about rolling component contributions to volatility.</p>
<p>This task had the potential to be quite straightforward with the following.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rolling_contribution &lt;-<span class="st"> </span><span class="kw">rollapply</span>(asset_returns_xts, window, 
                           <span class="cf">function</span>(x) <span class="kw">StdDev</span>(x, <span class="dt">weights =</span> w))</code></pre></div>
<p>That code throws an error to the effect that the weights vector does not play nicely with <code>rollapply()</code>. There might be a hack around this problem but let’s not look for the hack and take this as a good chance to tackle a problem where the built-in functions accomplish 90% of our task but we need to construct code for the final 10%. Our previous work manipulating objects from data frames to <code>xts</code> and slicing/dicing will serve us well here.</p>
<p>Our goal is to create a function that takes (1) a <code>data.frame</code> of asset returns and calculates the rolling contributions of each asset to volatility, based on a (2) starting date index and a (3) window, for a portfolio (4) with specified weights of each asset. We will need to supply four arguments to the function, accordingly.</p>
<p>We will get to the function in all its glory below, but before that here is the logic to construct that function (feel free to eviscerate this logic and replace it with something better).</p>
<ol style="list-style-type: decimal">
<li>Assign a start date for the first rolling calculation.</li>
<li>Assign end date based on the start date and window argument. If we set window = 6, we’ll be calculating contributions for the 6-month period between start date and end date.</li>
<li>Use <code>filter()</code> to subset the original <code>data.frame</code> down to one window. I label the subsetted data frame as <code>interval_to_use</code>. In our example, that interval is a 6-month window of our original data frame.</li>
<li>Now we want to pass that <code>interval_to_use</code> object to <code>StdDev()</code> but it’s not an <code>xts</code> object. We need to convert it and label it <code>returns_xts</code>.</li>
<li>Before we call <code>StdDev()</code>, we need weights. Create a weights object called <code>w</code> and assign the value from the argument we supplied to the function.</li>
<li>Pass the <code>returns_xts</code> and <code>w</code> to <code>StdDev()</code>, and set <code>portfolio_method = &quot;component&quot;</code>.</li>
<li>We now have an object called <code>results_as_xts</code>. What is this? It’s the risk contributions for each asset during the first 6-month window of our weighted portfolio. If our data starts at February, 2013, we now have one calculation for the period from February to August.</li>
<li>Convert it back to a <code>tibble</code> and return.</li>
<li>We now have the risk contributions for the 6-month period that started on the first date or February 2013 and ended in July 2013, because we default to <code>start = 1</code>. If we wanted to get the standard deviation for a 6-month period that started on the second date or March 2013, we could set <code>start = 2</code>, etc.</li>
<li>If we want risk contribution for all the 6-month periods, we need to apply this function starting at February, then March, then April, all the way to the month that is six months before the end of our data.</li>
</ol>
<p>Now, let’s turn those enumerated steps into a function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_interval_sd &lt;-<span class="st"> </span><span class="cf">function</span>(returns_df, <span class="dt">start =</span> <span class="dv">1</span>, <span class="dt">window =</span> <span class="dv">6</span>, weights){
  
  <span class="co"># First create start date. </span>
  start_date &lt;-<span class="st"> </span>returns_df<span class="op">$</span>date[start]
  
  <span class="co"># Next an end date that depends on start date and window.</span>
  end_date &lt;-<span class="st">  </span>returns_df<span class="op">$</span>date[<span class="kw">c</span>(start <span class="op">+</span><span class="st"> </span>window)]
  
  <span class="co"># Filter on start and end date.</span>
  interval_to_use &lt;-<span class="st"> </span>returns_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;=</span><span class="st"> </span>start_date <span class="op">&amp;</span><span class="st"> </span>date <span class="op">&lt;</span><span class="st"> </span>end_date)
  
  <span class="co"># Convert to xts so can use built in Performance Analytics function.</span>
  returns_xts &lt;-<span class="st"> </span>interval_to_use <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tk_xts</span>(<span class="dt">date_var =</span> date) 
  
  <span class="co"># Portfolio weights.</span>
  w &lt;-<span class="st"> </span>weights
  
  <span class="co"># Pass xts object to function.</span>
  results_as_xts &lt;-<span class="st"> </span><span class="kw">StdDev</span>(returns_xts, <span class="dt">weights =</span> w, <span class="dt">portfolio_method =</span> <span class="st">&quot;component&quot;</span>)
  
  <span class="co"># Convert results to tibble with a nicely formatted date.</span>
  results_to_tibble &lt;-<span class="st"> </span><span class="kw">tk_tbl</span>(<span class="kw">t</span>(results_as_xts<span class="op">$</span>pct_contrib_StdDev)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">ymd</span>(end_date)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate_if</span>(is.numeric, <span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(date, <span class="kw">everything</span>())  
}</code></pre></div>
<p>Let’s apply that function to a returns object to see the results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_my_function_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">my_interval_sd</span>(asset_returns_dplyr_byhand, <span class="dt">start =</span> <span class="dv">1</span>, <span class="dt">window =</span> <span class="dv">6</span>, <span class="dt">weights =</span> w)</code></pre></div>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_my_function_<span class="dv">1</span></code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   date         SPY   EFA   IJS   EEM   AGG
##   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 2013-08-31  21.6  36.9  13.9  24.0  3.62</code></pre>
<p>The function returns something, but what? It’s showing us the contribution to risk for each asset from February through August. The reason the date column is <code>2013-08-30</code> is that as of that date, this is the contribution over the previous 6 months of each asset.</p>
<p>What if we started at <code>start = 2</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_my_function_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">my_interval_sd</span>(asset_returns_dplyr_byhand, <span class="dt">start =</span> <span class="dv">2</span>, <span class="dt">window =</span> <span class="dv">6</span>, <span class="dt">weights =</span> w)</code></pre></div>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_my_function_<span class="dv">2</span></code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   date         SPY   EFA   IJS   EEM   AGG
##   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 2013-09-30  26.3  31.8  20.2  18.5  3.23</code></pre>
<p>We have moved up by one month to September.</p>
<p>We could keep doing this - applying our function to different start dates until we got to the end of our data, and then could past all of those objects together, but that’s not a pleasant prospect.</p>
<p>Instead we’ll use <code>map_df()</code> to apply the function to our entire return series, based on thed date column.</p>
<p>We will invoke <code>map_df()</code> to apply our function to date 1, then save the result to a <code>data.frame</code>, then apply our function to date 2, and save to that same <code>data.frame</code>, and so on until we tell it stop at the at index that is 6 months before the last date index.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">window &lt;-<span class="st"> </span><span class="dv">6</span>

portfolio_vol_components_tidy &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">map_df</span>(<span class="dv">1</span><span class="op">:</span>(<span class="kw">nrow</span>(asset_returns_dplyr_byhand)<span class="op">-</span>window), 
         my_interval_sd, 
         <span class="dt">returns_df =</span> asset_returns_dplyr_byhand, 
         <span class="dt">weights =</span> w, <span class="dt">window =</span> window)</code></pre></div>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<pre><code>## Warning in (0.5 * as.vector(dpm2))/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in contrib/sqrt(pm2): Recycling array of length 1 in vector-array arithmetic is deprecated.
##   Use c() or as.vector() instead.</code></pre>
<pre><code>## Warning in tk_tbl.data.frame(as.data.frame(data), preserve_index,
## rename_index, : Warning: No index to preserve. Object otherwise converted
## to tibble successfully.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">portfolio_vol_components_tidy</code></pre></div>
<pre><code>## # A tibble: 53 x 6
##    date         SPY   EFA   IJS   EEM    AGG
##    &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1 2013-08-31  21.6  36.9  13.9  24.0  3.62 
##  2 2013-09-30  26.3  31.8  20.2  18.5  3.23 
##  3 2013-10-31  19.0  33.3  19.2  25.3  3.22 
##  4 2013-11-30  20.3  31.1  19.1  26.3  3.23 
##  5 2013-12-31  22.2  29.1  21.5  24.4  2.83 
##  6 2014-01-31  22.4  28.4  25.0  21.6  2.47 
##  7 2014-02-28  21.4  28.7  21.1  28.6  0.211
##  8 2014-03-31  19.5  31.1  18.9  31.0 -0.542
##  9 2014-04-30  23.9  29.4  18.3  29.6 -1.23 
## 10 2014-05-31  23.4  30.1  19.6  28.8 -1.82 
## # ... with 43 more rows</code></pre>
<p>That combination of writing our own function, toggling between a data frame and an <code>xts</code> and then using <code>map_df()</code> is not simple. Make sure all the steps make sense before heading to the visualizationg below.</p>
<div id="visualizing-component-contribution-to-volatility" class="section level3 unnumbered">
<h3>Visualizing Component Contribution to Volatility</h3>
<p>Rolling component contribution to standard deviation is hard to grasp without data visualizations.</p>
<p>Let’s begin the aesthetic journey with <code>highcharter</code> by adding the rolling conbtribution of each asset to a chart.</p>
<p>First, we need to convert the <code>tibble</code> we just created to an <code>xts</code> object and that means a call out to <code>tk_xts(date_var = date)</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">portfolio_vol_components_tidy_xts &lt;-<span class="st"> </span>
<span class="st">  </span>portfolio_vol_components_tidy <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">tk_xts</span>(<span class="dt">date_var =</span> date)</code></pre></div>
<pre><code>## Warning in tk_xts_.data.frame(data = data, select = select, date_var =
## date_var, : Non-numeric columns being dropped: date</code></pre>
<p>Now we add each time series - which is the contribution of each asset to overall standard deviation - to the <code>highchart()</code> flow.</p>
<p>We are going to tweak the minimum and maximum y-axis values by adding <code>hc_yAxis(...max = max(portfolio_vol_components_tidy_xts) + 5, min = min(portfolio_vol_components_tidy_xts) - 5</code>. That line of code will set the maximum y-axis value to the highest value in our data + 5 and the minimum y-axis value to the lowest value in our data - 5. This is purely aesthetic to make the chart a bit more readable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">highchart</span>(<span class="dt">type =</span> <span class="st">&quot;stock&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">hc_title</span>(<span class="dt">text =</span> <span class="st">&quot;Volatility Contribution&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(portfolio_vol_components_tidy_xts[, <span class="dv">1</span>], <span class="dt">name =</span> symbols[<span class="dv">1</span>], <span class="dt">id =</span> symbols[<span class="dv">1</span>]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(portfolio_vol_components_tidy_xts[, <span class="dv">2</span>], <span class="dt">name =</span> symbols[<span class="dv">2</span>], <span class="dt">id =</span> symbols[<span class="dv">2</span>]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(portfolio_vol_components_tidy_xts[, <span class="dv">3</span>], <span class="dt">name =</span> symbols[<span class="dv">3</span>], <span class="dt">id =</span> symbols[<span class="dv">3</span>]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(portfolio_vol_components_tidy_xts[, <span class="dv">4</span>], <span class="dt">name =</span> symbols[<span class="dv">4</span>], <span class="dt">id =</span> symbols[<span class="dv">4</span>]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_add_series</span>(portfolio_vol_components_tidy_xts[, <span class="dv">5</span>], <span class="dt">name =</span> symbols[<span class="dv">5</span>], <span class="dt">id =</span> symbols[<span class="dv">5</span>]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_yAxis</span>(<span class="dt">labels =</span> <span class="kw">list</span>(<span class="dt">format =</span> <span class="st">&quot;{value}%&quot;</span>), 
           <span class="dt">max =</span> <span class="kw">max</span>(portfolio_vol_components_tidy_xts) <span class="op">+</span><span class="st"> </span><span class="dv">5</span>,
           <span class="dt">min =</span> <span class="kw">min</span>(portfolio_vol_components_tidy_xts) <span class="op">-</span><span class="st"> </span><span class="dv">5</span>,
           <span class="dt">opposite =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">hc_navigator</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">hc_scrollbar</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div id="htmlwidget-49dce6a5f7563f3ae7c2" style="width:100%;height:500px;" class="highchart html-widget"></div>
<script type="application/json" data-for="htmlwidget-49dce6a5f7563f3ae7c2">{"x":{"hc_opts":{"title":{"text":"Volatility Contribution"},"yAxis":{"title":{"text":null},"labels":{"format":"{value}%"},"max":67.5811591050604,"min":-35.0303199104636,"opposite":false},"credits":{"enabled":false},"exporting":{"enabled":false},"plotOptions":{"series":{"turboThreshold":0},"treemap":{"layoutAlgorithm":"squarified"},"bubble":{"minSize":5,"maxSize":25}},"annotationsOptions":{"enabledButtons":false},"tooltip":{"delayForDisplay":10},"series":[{"data":[[1377907200000,21.5541191014929],[1380499200000,26.2964809221755],[1383177600000,19.0206930243489],[1385769600000,20.2827764632442],[1388448000000,22.2175973492144],[1391126400000,22.4474359537863],[1393545600000,21.3863726641572],[1396224000000,19.5437770280702],[1398816000000,23.9284621850867],[1401494400000,23.4160884026477],[1404086400000,22.9767973972005],[1406764800000,22.5297433794344],[1409443200000,24.2720092094125],[1412035200000,27.1681925761052],[1414713600000,18.5917066938479],[1417305600000,18.1936078774171],[1419984000000,18.4844694190169],[1422662400000,19.8465499117],[1425081600000,21.4303680839263],[1427760000000,21.4253973727262],[1430352000000,28.6648484689124],[1433030400000,27.4419110364595],[1435622400000,26.2459950335295],[1438300800000,27.7934552973035],[1440979200000,22.9114695472693],[1443571200000,24.5147567674571],[1446249600000,25.1357031264537],[1448841600000,29.5261862492759],[1451520000000,29.2613827645777],[1454198400000,28.8421557796053],[1456704000000,29.0619489327595],[1459382400000,29.2177282080602],[1461974400000,25.0122430565789],[1464652800000,21.9868901608044],[1467244800000,21.8532111271827],[1469923200000,22.4127424619969],[1472601600000,19.3743758908546],[1475193600000,19.931719027726],[1477872000000,17.2603496219987],[1480464000000,19.6533471819749],[1483142400000,24.7858605589015],[1485820800000,24.7694850429456],[1488240000000,25.7120573670231],[1490918400000,28.0254102663297],[1493510400000,26.7553711750855],[1496188800000,52.8216670619043],[1498780800000,46.503701740884],[1501459200000,42.4283469023644],[1504137600000,39.5537303941542],[1506729600000,17.6395005773167],[1509408000000,17.9591417758952],[1512000000000,18.8285230335764],[1514678400000,18.7325481283847]],"name":"SPY","id":"SPY"},{"data":[[1377907200000,36.9014897514505],[1380499200000,31.7660704578492],[1383177600000,33.3033723338734],[1385769600000,31.1131953816463],[1388448000000,29.0616474384478],[1391126400000,28.4227064154379],[1393545600000,28.7363908910522],[1396224000000,31.1249253340554],[1398816000000,29.4459657289993],[1401494400000,30.0730791157275],[1404086400000,30.4790649274772],[1406764800000,29.3012436606682],[1409443200000,32.5980761130096],[1412035200000,17.789324815392],[1414713600000,19.6833412088976],[1417305600000,17.8570846374538],[1419984000000,16.61165558039],[1422662400000,16.9809286526461],[1425081600000,13.9532532453454],[1427760000000,24.671747312048],[1430352000000,27.1294426396814],[1433030400000,32.3750086567697],[1435622400000,32.0182223246103],[1438300800000,30.3512444152663],[1440979200000,31.5695488328548],[1443571200000,34.4215408453557],[1446249600000,35.9143561065805],[1448841600000,29.1542932183725],[1451520000000,28.8917555435095],[1454198400000,28.1992990303597],[1456704000000,27.7428797185849],[1459382400000,26.9642073007994],[1461974400000,25.2463376629736],[1464652800000,24.1471987134194],[1467244800000,24.0805722860617],[1469923200000,25.0341710333957],[1472601600000,27.0982828443632],[1475193600000,23.3510849517487],[1477872000000,27.3670811193385],[1480464000000,25.2210734280185],[1483142400000,23.085976294996],[1485820800000,23.4731163651331],[1488240000000,24.1510641448135],[1490918400000,23.7752621400376],[1493510400000,24.9411308328397],[1496188800000,-5.36609959897347],[1498780800000,-10.5443870657326],[1501459200000,24.0270335376946],[1504137600000,12.3460595871254],[1506729600000,33.6102652190809],[1509408000000,24.6181214557218],[1512000000000,24.7754303204173],[1514678400000,26.958926263622]],"name":"EFA","id":"EFA"},{"data":[[1377907200000,13.9441574563592],[1380499200000,20.2135109941731],[1383177600000,19.1969424761915],[1385769600000,19.112321867349],[1388448000000,21.5024304457662],[1391126400000,25.0355165269521],[1393545600000,21.0888467539987],[1396224000000,18.8921695650044],[1398816000000,18.2939524914423],[1401494400000,19.5613080371386],[1404086400000,17.8169021820091],[1406764800000,18.9606800327116],[1409443200000,34.7101803987184],[1412035200000,44.3915327635344],[1414713600000,31.3574806624989],[1417305600000,35.3824137344268],[1419984000000,37.4537169043421],[1422662400000,34.822299154857],[1425081600000,34.9390116320952],[1427760000000,29.1237882242391],[1430352000000,25.998394507263],[1433030400000,17.5511939121698],[1435622400000,16.925459609487],[1438300800000,17.9693780144116],[1440979200000,14.2307752668377],[1443571200000,8.61071734001865],[1446249600000,8.99344146844274],[1448841600000,18.2102099221648],[1451520000000,18.5442608820876],[1454198400000,20.0260115002272],[1456704000000,21.1214879677873],[1459382400000,24.1210253211361],[1461974400000,23.2888354972303],[1464652800000,25.0207655334613],[1467244800000,25.1015560851476],[1469923200000,23.3738799114364],[1472601600000,20.0790360849047],[1475193600000,22.4099919361171],[1477872000000,22.4105311550038],[1480464000000,27.6510136999982],[1483142400000,37.6391884984181],[1485820800000,36.3253810283921],[1488240000000,37.7144040364153],[1490918400000,34.0536525571713],[1493510400000,32.6668441797228],[1496188800000,-1.87134117540148],[1498780800000,14.288607830927],[1501459200000,-30.0303199104636],[1504137600000,-2.35514135633728],[1506729600000,20.7140476791395],[1509408000000,56.0726702295763],[1512000000000,54.5017723373838],[1514678400000,51.6460577130329]],"name":"IJS","id":"IJS"},{"data":[[1377907200000,23.9791919052271],[1380499200000,18.4957695983548],[1383177600000,25.2602032734348],[1385769600000,26.259596091927],[1388448000000,24.3919237735724],[1391126400000,21.6231247794593],[1393545600000,28.5775222322377],[1396224000000,30.9808417362395],[1398816000000,29.5642727218422],[1401494400000,28.7712705234374],[1404086400000,30.1855479181085],[1406764800000,30.6604034891917],[1409443200000,7.54242696575149],[1412035200000,8.33642958917717],[1414713600000,28.062792811285],[1417305600000,26.1652738615302],[1419984000000,25.2157259405908],[1422662400000,25.6562807564177],[1425081600000,27.8599990302086],[1427760000000,25.2877189994294],[1430352000000,20.5984479169805],[1433030400000,25.7675739402534],[1435622400000,27.6780515333671],[1438300800000,25.7325936453121],[1440979200000,32.2290458000232],[1443571200000,32.063843608198],[1446249600000,30.022623273672],[1448841600000,22.9246428282392],[1451520000000,23.1237238121301],[1454198400000,22.8150865812542],[1456704000000,22.3805387258385],[1459382400000,20.4665797611931],[1461974400000,26.5347188350591],[1464652800000,28.7427401181924],[1467244800000,28.866369361475],[1469923200000,29.3620003696262],[1472601600000,33.3423835627004],[1475193600000,33.7189488280894],[1477872000000,32.2793420490042],[1480464000000,25.2997905776878],[1483142400000,13.6463668714384],[1485820800000,13.9638241593529],[1488240000000,11.8649152250857],[1490918400000,12.7461354517132],[1493510400000,14.1226094623404],[1496188800000,57.3606512971771],[1498780800000,52.3635439282047],[1501459200000,62.5811591050604],[1504137600000,49.0854235441009],[1506729600000,30.0093283009462],[1509408000000,5.33883009009213],[1512000000000,5.76867057622837],[1514678400000,6.35763665416913]],"name":"EEM","id":"EEM"},{"data":[[1377907200000,3.6210417854703],[1380499200000,3.22816802744741],[1383177600000,3.2187888921513],[1385769600000,3.23211019583361],[1388448000000,2.82640099299916],[1391126400000,2.47121632436442],[1393545600000,0.210867458554116],[1396224000000,-0.541713663369408],[1398816000000,-1.23265312737055],[1401494400000,-1.82174607895115],[1404086400000,-1.45831242479537],[1406764800000,-1.45207056200599],[1409443200000,0.877307313108007],[1412035200000,2.31452025579125],[1414713600000,2.30467862347068],[1417305600000,2.401619889172],[1419984000000,2.23443215566026],[1422662400000,2.69394152437914],[1425081600000,1.81736800842445],[1427760000000,-0.508651908442736],[1430352000000,-2.39113353283731],[1433030400000,-3.13568754565231],[1435622400000,-2.86772850099385],[1438300800000,-1.84667137229354],[1440979200000,-0.940839446985064],[1443571200000,0.38914143897066],[1446249600000,-0.0661239751489753],[1448841600000,0.184667781947688],[1451520000000,0.178876997694982],[1454198400000,0.117447108553663],[1456704000000,-0.306855344970249],[1459382400000,-0.76954059118882],[1461974400000,-0.0821350518418456],[1464652800000,0.102405474122441],[1467244800000,0.0982911401330203],[1469923200000,-0.182793776455324],[1472601600000,0.105921617177088],[1475193600000,0.588255256318759],[1477872000000,0.682696054654702],[1480464000000,2.17477511232061],[1483142400000,0.842607776245962],[1485820800000,1.46819340417629],[1488240000000,0.557559226662451],[1490918400000,1.39953958474822],[1493510400000,1.51404435001166],[1496188800000,-2.94487758470628],[1498780800000,-2.6114664342831],[1501459200000,0.993780365344118],[1504137600000,1.36992783095681],[1506729600000,-1.97314177648325],[1509408000000,-3.98876355128548],[1512000000000,-3.87439626760579],[1514678400000,-3.69516875920876]],"name":"AGG","id":"AGG"}],"navigator":{"enabled":false},"scrollbar":{"enabled":false}},"theme":{"chart":{"backgroundColor":"transparent"}},"conf_opts":{"global":{"Date":null,"VMLRadialGradientURL":"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png","canvasToolsURL":"http =//code.highcharts.com/list(version)/modules/canvas-tools.js","getTimezoneOffset":null,"timezoneOffset":0,"useUTC":true},"lang":{"contextButtonTitle":"Chart context menu","decimalPoint":".","downloadJPEG":"Download JPEG image","downloadPDF":"Download PDF document","downloadPNG":"Download PNG image","downloadSVG":"Download SVG vector image","drillUpText":"Back to {series.name}","invalidDate":null,"loading":"Loading...","months":["January","February","March","April","May","June","July","August","September","October","November","December"],"noData":"No data to display","numericSymbols":["k","M","G","T","P","E"],"printChart":"Print chart","resetZoom":"Reset zoom","resetZoomTitle":"Reset zoom level 1:1","shortMonths":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"thousandsSep":" ","weekdays":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]}},"type":"stock","fonts":[],"debug":false},"evals":[],"jsHooks":[]}</script>
<p>For some reason, EEM rolling contribution spiked in June/July of 2017. Did something roil emerging markets in the preceding months? And IJS plunged. Something looks strange here.</p>
<p>As per our usual, let’s head to <code>ggplot()</code> and recreate that chart. Since our data object is still in wide format, we will need to make it long/tidy with <code>gather(asset, contribution, -date)</code>, then we can chart by asset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  portfolio_vol_components_tidy <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">gather</span>(asset, contribution, <span class="op">-</span>date) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(asset) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> contribution, <span class="dt">color =</span> asset)) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> percent)</code></pre></div>
<p><img src="bookdown_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<p>Those charts look consistent and we seem to have accomplished our task of breaking down portfolio volatility and visualizing its components over time. Let’s head to Shiny!</p>
</div>
<div id="shiny-component-contribution" class="section level3 unnumbered">
<h3>Shiny Component Contribution</h3>
<p>Our goal is to build a Shiny app that let’s the end user build a custom portfolio, select a rolling window, and chart the rolling contributions of each asset and the total contribution of each asset compared to it weight. It’s a lot to handle but we’ve already done the hard work.</p>
<p>Note that we are including 4 data visualizations from our previous work. 1) a highchart of rolling asset contribution 2) a <code>ggplot</code> of rolling asset contribution 3) a bar chart of asset contribution to volatility 4) a bar chart of asset weight and contribution</p>
<p>Have a look at the finished app here:</p>
<p>www.reproduciblefinance.com/shiny/volatility-contribution/</p>
<p>And here is a snapshot</p>
<div class="figure"><span id="fig:unnamed-chunk-51"></span>
<img src="snapshots/highcharter-weights.png" alt="Component Contribution Shiny App" width="100%" />
<p class="caption">
FIGURE 5.1: Component Contribution Shiny App
</p>
</div>
<p>Let’s get started.</p>
<p>By now you’re probably tired of hearing that our input sidebar will let the user choose stocks, weights and a start date, plus a rolling window. If that sidebar is now boringly easy to build, that’s okay and, in fact, maybe it’s fantastic. Setting up the data selection aspect of portfolio Shiny apps is starting to feel like second nature. Let’s move to the substance.</p>
<p>We are performing more involved calculations in this app and using our own function <code>my_interval_sd()</code>. We can define it in a separate code chunk from the input sidebar.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_interval_sd &lt;-<span class="st"> </span><span class="cf">function</span>(returns_df, <span class="dt">start =</span> <span class="dv">1</span>, weights, <span class="dt">window =</span> <span class="dv">20</span>){
  
  <span class="co"># First create start date</span>
  start_date =<span class="st"> </span>returns_df<span class="op">$</span>date[start]
  
  <span class="co"># Next an end date</span>
  end_date =<span class="st"> </span>returns_df<span class="op">$</span>date[<span class="kw">c</span>(start <span class="op">+</span><span class="st"> </span>window)]
  
  <span class="co"># Filter on start and end date</span>
  interval_to_use &lt;-<span class="st"> </span>returns_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(date <span class="op">&gt;=</span><span class="st"> </span>start_date <span class="op">&amp;</span><span class="st"> </span>date <span class="op">&lt;</span><span class="st"> </span>end_date)
  
  <span class="co"># Convert to xts so can use built in Performance Analytics function.</span>
  returns_xts &lt;-<span class="st"> </span>interval_to_use <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tk_xts</span>(<span class="dt">date_var =</span> date) 
  
  <span class="co"># Portfolio weights.</span>
  w &lt;-<span class="st"> </span>weights
  
  <span class="co"># Pass xts object to function.</span>
  results_as_xts &lt;-<span class="st"> </span><span class="kw">StdDev</span>(returns_xts, <span class="dt">weights =</span> w, <span class="dt">portfolio_method =</span> <span class="st">&quot;component&quot;</span>)
  
  <span class="co"># Convert results to tibble.</span>
  results_to_tibble &lt;-<span class="st"> </span><span class="kw">tk_tbl</span>(<span class="kw">t</span>(results_as_xts<span class="op">$</span>pct_contrib_StdDev)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">ymd</span>(end_date)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate_if</span>(is.numeric, <span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(date, <span class="kw">everything</span>()) 
}</code></pre></div>
<p>We also need to calculate asset returns using an <code>eventReactive()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">asset_returns_dplyr_byhand &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {
  
  symbols &lt;-<span class="st"> </span><span class="kw">c</span>(input<span class="op">$</span>stock1, input<span class="op">$</span>stock2, input<span class="op">$</span>stock3, input<span class="op">$</span>stock4, input<span class="op">$</span>stock5)
  
  prices &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">getSymbols</span>(symbols, <span class="dt">src =</span> <span class="st">&#39;yahoo&#39;</span>, <span class="dt">from =</span> input<span class="op">$</span>date, 
               <span class="dt">auto.assign =</span> <span class="ot">TRUE</span>, <span class="dt">warnings =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">map</span>(<span class="op">~</span><span class="kw">Ad</span>(<span class="kw">get</span>(.))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">reduce</span>(merge) <span class="op">%&gt;%</span>
<span class="st">    `</span><span class="dt">colnames&lt;-</span><span class="st">`</span>(symbols)

  
  asset_returns_dplyr_byhand &lt;-<span class="st"> </span>
<span class="st">    </span>prices <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">to.monthly</span>(<span class="dt">indexAt =</span> <span class="st">&quot;last&quot;</span>, <span class="dt">OHLC =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">tk_tbl</span>(<span class="dt">preserve_index =</span> <span class="ot">TRUE</span>, <span class="dt">rename_index =</span> <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">gather</span>(asset, returns, <span class="op">-</span>date) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(asset) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">returns =</span> (<span class="kw">log</span>(returns) <span class="op">-</span><span class="st"> </span><span class="kw">log</span>(<span class="kw">lag</span>(returns)))) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">spread</span>(asset, returns) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(date, symbols) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">slice</span>(<span class="op">-</span><span class="dv">1</span>)
})</code></pre></div>
<p>We want to calculate overall contribution to risk so we can create those bar charts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">percentages_tibble_pre_built &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {
  
  asset_returns_xts &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">asset_returns_dplyr_byhand</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">tk_xts</span>(<span class="dt">date_col =</span> date)
  
  w &lt;-<span class="st"> </span><span class="kw">c</span>(input<span class="op">$</span>w1<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w2<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w3<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w4<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w5<span class="op">/</span><span class="dv">100</span>)
  
  portfolio_vol_comp_contr_total_builtin &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">StdDev</span>(asset_returns_xts, 
           <span class="dt">weights =</span> w,
           <span class="dt">portfolio_method =</span> <span class="st">&quot;component&quot;</span>)
  
  symbols &lt;-<span class="st"> </span><span class="kw">c</span>(input<span class="op">$</span>stock1, input<span class="op">$</span>stock2, input<span class="op">$</span>stock3, input<span class="op">$</span>stock4, input<span class="op">$</span>stock5)
  
  percentages_tibble_pre_built &lt;-<span class="st"> </span>
<span class="st">    </span>portfolio_vol_comp_contr_total_builtin<span class="op">$</span>pct_contrib_StdDev <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tk_tbl</span>(<span class="dt">preserve_index =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">asset =</span> symbols) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rename</span>(<span class="st">&#39;risk contribution&#39;</span> =<span class="st"> </span>data) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">risk contribution</span><span class="st">`</span> =<span class="st"> </span><span class="kw">round</span>(<span class="st">`</span><span class="dt">risk contribution</span><span class="st">`</span>, <span class="dv">4</span>) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, 
           <span class="dt">weights =</span> w <span class="op">*</span><span class="st"> </span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(asset, <span class="kw">everything</span>())
  
})</code></pre></div>
<p>And finally our major calculation for this Shiny app: calculate contribution to volatility, over time, using our hand-built function, and applying it with <code>map_df()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">portfolio_vol_components_tidy &lt;-<span class="st"> </span><span class="kw">eventReactive</span>(input<span class="op">$</span>go, {
  
  asset_returns_dplyr_byhand &lt;-<span class="st"> </span><span class="kw">asset_returns_dplyr_byhand</span>()
  
  w &lt;-<span class="st"> </span><span class="kw">c</span>(input<span class="op">$</span>w1<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w2<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w3<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w4<span class="op">/</span><span class="dv">100</span>, input<span class="op">$</span>w5<span class="op">/</span><span class="dv">100</span>)
  
   port_components_tidy &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">map_df</span>(<span class="dv">1</span><span class="op">:</span>(<span class="kw">nrow</span>(asset_returns_dplyr_byhand)<span class="op">-</span>input<span class="op">$</span>window), 
           my_interval_sd, <span class="dt">returns_df =</span> asset_returns_dplyr_byhand, 
           <span class="dt">weights =</span> w, <span class="dt">window =</span> input<span class="op">$</span>window) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate_all</span>(<span class="kw">funs</span>(<span class="kw">round</span>(., <span class="dv">3</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">ymd</span>(date)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(date, <span class="kw">everything</span>()) 
})</code></pre></div>
<p>From here we visualize first with <code>highcharter</code>. That means we take the tidy reactive object <code>portfolio_vol_components</code> and convert to <code>xts</code> with <code>tk_xts(date_col = date)</code>. Then we pass to <code>highchart()</code> in the same way we did above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">renderHighchart</span>({

  portfolio_vol_components &lt;-<span class="st"> </span>
<span class="st">    </span><span class="kw">portfolio_vol_components_tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">tk_xts</span>(<span class="dt">date_col =</span> date)
  
  <span class="kw">highchart</span>(<span class="dt">type =</span> <span class="st">&quot;stock&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">hc_title</span>(<span class="dt">text =</span> <span class="st">&quot;Volatility Contribution&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">hc_add_series</span>(portfolio_vol_components[, <span class="dv">1</span>], 
                  <span class="dt">name =</span> <span class="kw">names</span>(portfolio_vol_components[, <span class="dv">1</span>])) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">hc_add_series</span>(portfolio_vol_components[, <span class="dv">2</span>], 
                  <span class="dt">name =</span> <span class="kw">names</span>(portfolio_vol_components[, <span class="dv">2</span>])) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">hc_add_series</span>(portfolio_vol_components[, <span class="dv">3</span>], 
                  <span class="dt">name =</span> <span class="kw">names</span>(portfolio_vol_components[, <span class="dv">3</span>])) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">hc_add_series</span>(portfolio_vol_components[, <span class="dv">4</span>], 
                  <span class="dt">name =</span> <span class="kw">names</span>(portfolio_vol_components[, <span class="dv">4</span>])) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">hc_add_series</span>(portfolio_vol_components[, <span class="dv">5</span>], 
                  <span class="dt">name =</span> <span class="kw">names</span>(portfolio_vol_components[, <span class="dv">5</span>])) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">hc_add_theme</span>(<span class="kw">hc_theme_flat</span>()) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">hc_yAxis</span>(
      <span class="dt">labels =</span> <span class="kw">list</span>(<span class="dt">format =</span> <span class="st">&quot;{value}%&quot;</span>), 
             <span class="dt">opposite =</span> <span class="ot">FALSE</span>, 
             <span class="dt">min =</span> <span class="kw">min</span>(portfolio_vol_components) <span class="op">-</span><span class="dv">5</span>,
             <span class="dt">max =</span> <span class="kw">max</span>(portfolio_vol_components) <span class="op">+</span><span class="st"> </span><span class="dv">5</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">hc_navigator</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">hc_scrollbar</span>(<span class="dt">enabled =</span> <span class="ot">FALSE</span>)
})</code></pre></div>
<p>Our <code>ggplot</code> of rolling component contributions should look familiar too. Start with thet tidy object <code>portfolio_vol_components_tidy()</code>, transform to long formatted with <code>gather(asset, contribution, -date)</code> and then head to the aesthetics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">renderPlot</span>(
  <span class="kw">portfolio_vol_components_tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">gather</span>(asset, contribution, <span class="op">-</span>date) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">contribution =</span> contribution<span class="op">/</span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(asset) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> contribution, <span class="dt">color =</span> asset)) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> percent, <span class="dt">breaks =</span> <span class="kw">pretty_breaks</span>(<span class="dt">n =</span> <span class="dv">20</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Rolling Percent Contribution to Volatility&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Asset&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Percent Contribution to Risk&quot;</span>)
)</code></pre></div>
<p>We pass it the reactive <code>percentages_tibble_pre_built()</code>, and then pipe straight to <code>ggplot()</code>. From there it’s the same as we did the bar charts above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">renderPlot</span>({
<span class="kw">percentages_tibble_pre_built</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">risk contribution</span><span class="st">`</span> =<span class="st"> `</span><span class="dt">risk contribution</span><span class="st">`</span><span class="op">/</span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> asset, <span class="dt">y =</span> <span class="st">`</span><span class="dt">risk contribution</span><span class="st">`</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">fill =</span> <span class="st">&#39;cornflowerblue&#39;</span>, <span class="dt">colour =</span> <span class="st">&#39;pink&#39;</span>, <span class="dt">width =</span> .<span class="dv">6</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> percent, <span class="dt">breaks =</span> <span class="kw">pretty_breaks</span>(<span class="dt">n =</span> <span class="dv">20</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Percent Contribution to Volatility&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Asset&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Percent Contribution to Risk&quot;</span>)
})</code></pre></div>
<p>And here is the code for the chart shows both an asset’s weight and it’s contribution to volatility. Again, we pass it the reactive <code>percentages_tibble_pre_built()</code>, use <code>gather(type, percent, -asset) %&gt;% group_by(type)</code> to make it long formatted and then pipe straight to <code>ggplot()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">renderPlot</span>(
  <span class="kw">percentages_tibble_pre_built</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">gather</span>(type, percent, <span class="op">-</span>asset) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(type) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">percent =</span> percent<span class="op">/</span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> asset, <span class="dt">y =</span> percent, <span class="dt">fill =</span> type)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">&#39;dodge&#39;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> percent) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Percent Contribution to Volatility&quot;</span>)
)</code></pre></div>
<p>That’s all for this Shiny app.</p>
</div>
<div id="conclusion-on-standard-deviation" class="section level3 unnumbered">
<h3>Conclusion on Standard Deviation</h3>
<p>That concludes our work on portfolio volatility and standard deviation.</p>
<p>We covered a lot of ground here: overalll standard deviation of returns, rolling standard deviation of returns, component contribution and rollingn component contribution. We also created several data visualizations and ported those over to Shiny. Very importantly, we wrote our own function, that used a tibble, toggled to an <code>xts</code> for a function, then toggled back to a <code>tibble</code>, then we used <code>map_df()</code> to apply that function.</p>
<p>That is one of the more involved tasks that we will tackle, perhaps the most involved, and if we have a firm grasp on that one, we are ready for just about anything.</p>
<p>In the next section, we will explore skewness and kurtosis, distribution concepts that are important when assessing the risk of a portfolio.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="component-contribution-to-volatility.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="portfolio-theory.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/yihui/bookdown-crc/edit/master/risk.Rmd",
"text": "Edit"
},
"download": ["bookdown.pdf", "bookdown.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
